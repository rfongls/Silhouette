import json
import os
import datetime as dt
from pathlib import Path
from skills.cyber_common import require_auth_and_scope, write_result, Deny


def _verify_ownership(target: str) -> None:
    checked = False
    allow_path = os.environ.get("CYBER_ALLOWLIST")
    if allow_path and Path(allow_path).exists():
        checked = True
        allowed = {l.strip() for l in Path(allow_path).read_text().splitlines() if l.strip()}
        if target in allowed:
            return
    dns_dir = os.environ.get("CYBER_DNS_DIR")
    if dns_dir and (Path(dns_dir) / f"{target}.txt").exists():
        checked = True
        return
    http_dir = os.environ.get("CYBER_HTTP_DIR")
    if http_dir and (Path(http_dir) / f"{target}.txt").exists():
        checked = True
        return
    if checked:
        raise Deny("Ownership verification failed")


def _enforce_throttle() -> None:
    throttle = float(os.environ.get("CYBER_THROTTLE_SECONDS", "0") or 0)
    if throttle <= 0:
        return
    stamp = Path.home() / ".cyber_pentest_last"
    now = dt.datetime.utcnow().timestamp()
    if stamp.exists():
        try:
            last = float(stamp.read_text())
            if now - last < throttle:
                raise Deny("Throttle active")
        except ValueError:
            pass
    stamp.write_text(str(now))


def _append_audit_log(entry: dict) -> None:
    """Persist audit decisions across runs."""
    log = Path.home() / ".cyber_pentest_audit.log"
    with log.open("a") as fh:
        fh.write(json.dumps(entry) + "\n")


def tool(payload: str) -> str:
    """Validate authorization and scope before running pentest activity.

    Input JSON: {"target":"example.com","scope_file":"scope.txt","auth_doc":"auth.pdf","out_dir":"..."}
    """
    args = json.loads(payload or "{}")
    target = args.get("target", "")
    scope_file = args.get("scope_file", "scope.txt")
    auth_doc = args.get("auth_doc")
    out_dir = args.get("out_dir")
    user = os.environ.get("USER", "unknown")
    deny_path = os.environ.get("CYBER_DENY_LIST")
    window = os.environ.get("CYBER_PENTEST_WINDOW")
    try:
        if os.environ.get("CYBER_KILL_SWITCH", "").lower() in {"1", "true", "on"}:
            raise Deny("Global kill switch active")
        require_auth_and_scope(scope_file, target)
        _verify_ownership(target)
        _enforce_throttle()
        if not auth_doc or not Path(auth_doc).exists():
            raise Deny("Authorization document required")
        if deny_path and Path(deny_path).exists():
            denied = {l.strip() for l in Path(deny_path).read_text().splitlines() if l.strip()}
            if target in denied:
                raise Deny("Target denied")
        if window:
            try:
                start_s, end_s = window.split("-", 1)
                now = dt.datetime.utcnow().time()
                start = dt.time.fromisoformat(start_s)
                end = dt.time.fromisoformat(end_s)
                if not (start <= now <= end):
                    raise Deny("Outside authorized window")
            except ValueError:
                pass
        data = {"target": target, "scope_file": scope_file, "auth_doc": auth_doc}
        path = write_result("pentest_gate", data, run_dir=out_dir)
        audit = {
            "target": target,
            "auth_doc": auth_doc,
            "decision": "allow",
            "user": user,
            "ts": dt.datetime.utcnow().isoformat(),
        }
        write_result("pentest_gate_audit", audit, run_dir=out_dir)
        _append_audit_log(audit)
        return json.dumps({"ok": True, "result": path})
    except Deny as e:
        audit = {
            "target": target,
            "auth_doc": auth_doc,
            "decision": "deny",
            "reason": str(e),
            "user": user,
            "ts": dt.datetime.utcnow().isoformat(),
        }
        write_result("pentest_gate_audit", audit, run_dir=out_dir)
        _append_audit_log(audit)
        return json.dumps({"ok": False, "deny": str(e)})

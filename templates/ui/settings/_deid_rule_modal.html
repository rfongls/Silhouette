{% set preset_options = ['name','birthdate','datetime','gender','address','phone','language','race','mrn','ssn','facility','note','pdf_blob','xml_blob'] %}
{% set act = clone.action if clone else 'redact' %}
{% set preset_value = preset_options[0] %}
{% if clone and act == 'preset' and clone.param in preset_options %}
  {% set preset_value = clone.param %}
{% endif %}
{% set param_mode = 'preset' %}
{% if clone and act == 'preset' and (clone.param is not none) and (clone.param not in preset_options) %}
  {% set param_mode = 'free' %}
{% endif %}
{% set free_value = '' %}
{% if clone %}
  {% if act in ['replace','mask','hash'] %}
    {% set free_value = clone.param or '' %}
  {% elif act == 'preset' and (clone.param is not none) and (clone.param not in preset_options) %}
    {% set free_value = clone.param %}
  {% endif %}
{% endif %}
{% set regex_pattern = '' %}
{% set regex_replacement = '' %}
{% if clone and act == 'regex_redact' %}
  {% set regex_pattern = clone.param or '' %}
{% elif clone and act == 'regex_replace' %}
  {% set raw_regex_param = clone.param or '' %}
  {% if raw_regex_param and raw_regex_param.strip().startswith('{') %}
    {% set parsed = raw_regex_param | fromjson(default={}) %}
    {% set regex_pattern = parsed.get('pattern', '') %}
    {% set regex_replacement = parsed.get('repl', '') %}
  {% elif raw_regex_param and ':::' in raw_regex_param %}
    {% set regex_pattern = raw_regex_param.split(':::', 1)[0] %}
    {% set regex_replacement = raw_regex_param.split(':::', 1)[1] %}
  {% else %}
    {% set regex_pattern = raw_regex_param %}
  {% endif %}
{% endif %}

<div class="modal-backdrop"></div>
<div class="modal" id="deid-modal"
     data-test-endpoint="{{ request.url_for('api_deid_test_rule') }}"
     hx-on::after-swap="initDeidModal('#deid-modal')">
  <div class="modal-card">
    <div class="modal-header">
      <h3 class="text-h3">{% if clone %}Clone De-identification Rule{% else %}Add De-identification Rule{% endif %}</h3>
      <button class="button ghost" type="button" onclick="document.getElementById('deid-modal').remove()">✕</button>
    </div>

    <form id="deid-modal-form"
          hx-post="{{ request.url_for('ui_settings_deid_add_rule', name=tpl.name) }}"
          hx-target="#deid-rules"
          hx-on::before-submit="initDeidModal('#deid-modal')"
          hx-on::after-request="document.getElementById('deid-modal').remove()">

      <div class="grid two">
        <label>Segment <input class="input" name="segment" id="m-seg" placeholder="PID" required value="{{ clone.segment if clone else '' }}"></label>
        <label>Field   <input class="input" name="field" id="m-field" type="number" min="1" required value="{{ clone.field if clone else '' }}"></label>
        <label>Component <input class="input" name="component" id="m-comp" type="number" min="1" value="{{ clone.component if clone and clone.component is not none else '' }}"></label>
        <label>Subcomponent <input class="input" name="subcomponent" id="m-sub" type="number" min="1" value="{{ clone.subcomponent if clone and clone.subcomponent is not none else '' }}"></label>
      </div>

      <div class="grid two mt">
        <label>Action
          <select class="input" name="action" id="m-action">
            <option value="redact"         {{ 'selected' if act=='redact' else '' }}>redact</option>
            <option value="mask"           {{ 'selected' if act=='mask' else '' }}>mask</option>
            <option value="hash"           {{ 'selected' if act=='hash' else '' }}>hash</option>
            <option value="replace"        {{ 'selected' if act=='replace' else '' }}>replace (literal)</option>
            <option value="preset"         {{ 'selected' if act=='preset' else '' }}>preset (synthetic)</option>
            <option value="regex_redact"   {{ 'selected' if act=='regex_redact' else '' }}>regex redact</option>
            <option value="regex_replace"  {{ 'selected' if act=='regex_replace' else '' }}>regex replace</option>
          </select>
        </label>

        <label id="m-param-mode-wrap" style="display:none">Parameter mode
          <select class="input" id="m-param-mode">
            <option value="preset" {{ 'selected' if param_mode == 'preset' else '' }}>Preset</option>
            <option value="free" {{ 'selected' if param_mode == 'free' else '' }}>Free-text</option>
          </select>
        </label>
      </div>

      <div id="m-preset-wrap" class="mt" style="display:none">
        <label>Preset key
          <select class="input" id="m-preset">
            {% for opt in preset_options %}
              <option value="{{ opt }}" {{ 'selected' if preset_value==opt else '' }}>{{ opt }}</option>
            {% endfor %}
          </select>
        </label>
      </div>

      <div id="m-free-wrap" class="mt" style="display:none">
        <label>Value / Param <input class="input" id="m-free" placeholder="*, SALT123, fixed text" value="{{ free_value }}"></label>
      </div>

      <div id="m-regex-wrap" class="mt" style="display:none">
        <div class="grid two">
          <label>Regex pattern <input class="input" id="m-rx-pattern" placeholder="e.g., ^\\d{6}$" value="{{ regex_pattern }}"></label>
          <label id="m-rx-repl-wrap" style="display:none">Replacement (for regex_replace) <input class="input" id="m-rx-repl" placeholder="***000" value="{{ regex_replacement }}"></label>
        </div>
        <p class="muted">Regex is time-bounded &amp; length-limited. Use <code>regex_redact</code> to mask matches, <code>regex_replace</code> to replace.</p>
      </div>

      <input type="hidden" id="m-param-hidden" />
      <div class="row gap small mt"><span class="badge muted">Path</span><span class="badge mono" id="m-path-badge">—</span></div>
      <div class="card mt">
        <h4 class="text-h4">Test &amp; Preview</h4>
        <label>Sample HL7 snippet
          <textarea class="input" id="m-sample" rows="5">PID|1||444444^^^HOSP^MR||DOE^JOHN||19800101|M</textarea>
        </label>
        <div class="row mt"><button class="button" type="button" data-deid-test>Test</button></div>
        <div class="grid two mt">
          <div><h5 class="text-h5">Before (field)</h5><div id="m-before-diff" class="diff muted"></div></div>
          <div><h5 class="text-h5">After (field)</h5><div id="m-after-diff" class="diff"></div></div>
        </div>
        <div class="grid two mt">
          <div><h5 class="text-h5">Line — original</h5><div id="m-msg-before" class="diff"></div></div>
          <div><h5 class="text-h5">Line — transformed</h5><div id="m-msg-after" class="diff"></div></div>
        </div>
      </div>

      <div class="row end mt">
        <button type="button" class="button ghost" onclick="document.getElementById('deid-modal').remove()">Cancel</button>
        <button class="button">Save rule</button>
      </div>
    </form>
  </div>
</div>

<style>
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.2);backdrop-filter:blur(1px);}
.modal{position:fixed;inset:0;display:grid;place-items:center;z-index:50;}
.modal-card{background:var(--card-bg,#0b1220);color:var(--card-fg,#e5e7eb);border-radius:1rem;padding:1rem 1.25rem;min-width:820px;max-width:92vw;box-shadow:0 10px 30px rgba(0,0,0,.25);}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;}
.grid.two{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;}
.row{display:flex;gap:.5rem;align-items:center}
.row.end{justify-content:flex-end;}
.input{width:100%}
.diff{white-space:pre-wrap;background:rgba(15,23,42,.45);border-radius:.5rem;padding:.5rem;min-height:2.25rem;}
.badge{display:inline-block;font-size:.85rem;line-height:1;padding:.35rem .5rem;border-radius:.5rem;background:rgba(99,102,241,.12);color:#a5b4fc;border:1px solid rgba(99,102,241,.35)}
.badge.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.badge.muted{background:rgba(148,163,184,.15);color:#cbd5e1;border-color:rgba(148,163,184,.35)}
</style>

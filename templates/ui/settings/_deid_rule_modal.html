<!-- PARAM-MODAL v7 -->
<div class="modal-backdrop"></div>
<div class="modal" id="deid-modal"
     data-param-debug="0"
     data-test-endpoint="{{ request.url_for('api_deid_test_rule') }}"
     hx-on::after-settle="try { initDeidModal('#deid-modal'); } catch (e) { console.error(e); }">
  <div class="modal-card">
    <div class="modal-header">
      <h3 class="text-h3">{% if clone %}Clone De-identification Rule{% else %}Add De-identification Rule{% endif %}</h3>
      <button class="button ghost" type="button" onclick="document.getElementById('deid-modal').remove()">✕</button>
    </div>

    <form id="deid-modal-form"
          hx-post="{{ request.url_for('ui_settings_deid_add_rule', name=tpl.name) }}"
          hx-target="#deid-rules"
          hx-on::after-request="if (event.detail.elt === this) { document.getElementById('deid-modal').remove() }">

      <div class="grid two">
        <label>Segment <input class="input" name="segment" id="m-seg" placeholder="PID" required value="{{ clone.segment if clone else '' }}"></label>
        <label>Field   <input class="input" name="field" id="m-field" type="number" min="1" required value="{{ clone.field if clone else '' }}"></label>
        <label>Component <input class="input" name="component" id="m-comp" type="number" min="1" value="{{ clone.component if clone and clone.component is not none else '' }}"></label>
        <label>Subcomponent <input class="input" name="subcomponent" id="m-sub" type="number" min="1" value="{{ clone.subcomponent if clone and clone.subcomponent is not none else '' }}"></label>
      </div>

      <div id="param-harness"
           hx-get="{{ request.url_for('ui_settings_deid_param_controls') }}"
           hx-trigger="load delay:25ms"
           hx-include="#deid-modal-form"
           hx-target="#param-controls"
           hx-swap="innerHTML">

        <div class="grid two mt">
          <label>Action
            {% set act = clone.action if clone else 'redact' %}
            <select class="input" name="action" id="m-action"
                    hx-get="{{ request.url_for('ui_settings_deid_param_controls') }}"
                    hx-target="#param-controls"
                    hx-trigger="change"
                    hx-include="#deid-modal-form"
                    hx-swap="innerHTML">
              <option value="redact"        {{ 'selected' if act=='redact' else '' }}>redact</option>
              <option value="mask"          {{ 'selected' if act=='mask' else '' }}>mask</option>
              <option value="hash"          {{ 'selected' if act=='hash' else '' }}>hash</option>
              <option value="replace"       {{ 'selected' if act=='replace' else '' }}>replace (literal)</option>
              <option value="preset"        {{ 'selected' if act=='preset' else '' }}>preset (synthetic)</option>
              <option value="regex_redact"  {{ 'selected' if act=='regex_redact' else '' }}>regex redact</option>
              <option value="regex_replace" {{ 'selected' if act=='regex_replace' else '' }}>regex replace</option>
            </select>
          </label>
        </div>

        <input type="hidden" name="param_mode" value="{{ initial_param_mode or 'preset' }}">
        <input type="hidden" name="initial_param_mode" value="{{ initial_param_mode or 'preset' }}">
        <input type="hidden" name="initial_param_preset" value="{{ initial_param_preset or '' }}">
        <input type="hidden" name="initial_param_free" value="{{ initial_param_free or '' }}">
        <input type="hidden" name="initial_pattern" value="{{ initial_pattern or '' }}">
        <input type="hidden" name="initial_repl" value="{{ initial_repl or '' }}">

        <div id="param-controls" class="mt">
          <p class="muted">Loading parameters…</p>
        </div>
      </div>
      <div class="card mt">
        <h4 class="text-h4">Test &amp; Preview</h4>
        <label>Sample HL7 snippet
          <textarea class="input" id="m-sample" rows="5">PID|1||444444^^^HOSP^MR||DOE^JOHN||19800101|M</textarea>
        </label>
        <div class="row mt"><button class="button" type="button" data-deid-test>Test</button></div>
        <div class="grid two mt">
          <div><h5 class="text-h5">Before (field)</h5><div id="m-before-diff" class="diff muted"></div></div>
          <div><h5 class="text-h5">After (field)</h5><div id="m-after-diff" class="diff"></div></div>
        </div>
        <div class="grid two mt">
          <div><h5 class="text-h5">Line — original</h5><div id="m-msg-before" class="diff"></div></div>
          <div><h5 class="text-h5">Line — transformed</h5><div id="m-msg-after" class="diff"></div></div>
        </div>
      </div>

      <div class="modal-scroll-controls">
        <button type="button" class="btn" id="deid-scroll-down">Scroll down</button>
        <button type="button" class="btn" id="deid-scroll-top" hidden>Back to top</button>
      </div>

      <div class="row end mt">
        <button type="button" class="button ghost" onclick="document.getElementById('deid-modal').remove()">Cancel</button>
        <button class="button">Save rule</button>
      </div>
    </form>
  </div>
</div>

<style>
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.2);backdrop-filter:blur(1px);}
.modal{position:fixed;inset:0;display:grid;place-items:center;z-index:50;padding:1rem;}
.modal-card{background:var(--card-bg,#0b1220);color:var(--card-fg,#e5e7eb);border-radius:1rem;padding:1rem 1.25rem;width:min(760px,92vw);max-height:72vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.25);border:1px solid var(--border-strong,#2b2f3a);}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;}
.grid.two{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.75rem;}
.grid.two>label{display:flex;flex-direction:column;gap:.25rem;min-width:0;}
.row{display:flex;gap:.5rem;align-items:center}
.row.end{justify-content:flex-end;}
.input{width:100%;min-width:0;}
.diff{white-space:pre-wrap;background:rgba(15,23,42,.45);border-radius:.5rem;padding:.5rem;min-height:2.25rem;color:var(--text-primary,#e6e9f2);word-break:break-word;}
.badge{display:inline-block;font-size:.85rem;line-height:1;padding:.35rem .5rem;border-radius:.5rem;background:rgba(99,102,241,.12);color:#a5b4fc;border:1px solid rgba(99,102,241,.35)}
.badge.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.badge.muted{background:rgba(148,163,184,.15);color:#cbd5e1;border-color:rgba(148,163,184,.35)}
/* --- Precision highlight: only the changed bits in red --- */
#deid-modal .diff ins.added{color:#ef4444;background:transparent;text-decoration:none;}
#deid-modal .diff del.removed{color:#94a3b8;text-decoration:line-through;}
#deid-modal .diff .same{color:inherit;}
/* Sticky scroll controls inside modal */
#deid-modal .modal-scroll-controls{position:sticky;bottom:8px;display:flex;gap:8px;justify-content:flex-end;padding:8px 0;pointer-events:none;}
#deid-modal .modal-scroll-controls .btn{pointer-events:auto;border:1px solid var(--border-strong,#2b2f3a);background:rgba(20,24,31,.75);padding:6px 10px;border-radius:6px;font-size:12px;color:var(--text-primary,#e6e9f2);}
</style>

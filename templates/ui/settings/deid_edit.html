{% extends "layout.html" %}
{% block content %}
<h1 class="text-h1">De-identify Template — {{ tpl.name }}</h1>

<div class="row gap">
  <a class="button" href="{{ request.url_for('ui_settings_deid_export_json', name=tpl.name) }}">Export JSON</a>
  <a class="button" href="{{ request.url_for('ui_settings_deid_export_csv', name=tpl.name) }}">Export CSV</a>
  <form class="row gap small" hx-post="{{ request.url_for('ui_settings_deid_import_csv', name=tpl.name) }}" hx-target="#deid-rules">
    <input type="file" name="file" accept=".csv" required />
    <button class="button">Import CSV</button>
  </form>
  <form class="row gap small" hx-post="{{ request.url_for('ui_settings_deid_seed_defaults', name=tpl.name) }}" hx-target="#deid-rules">
    <button class="button secondary">Seed defaults</button>
  </form>
  <form class="row gap small" hx-post="{{ request.url_for('ui_settings_deid_delete') }}" hx-target="body" onsubmit="return confirm('Delete template {{ tpl.name }}?')">
    <input type="hidden" name="name" value="{{ tpl.name }}">
    <button class="button danger">Delete template</button>
  </form>
</div>

<div class="card mt">
  <h2 class="text-h2">Rules</h2>
  <form class="row gap small mb" hx-post="{{ request.url_for('ui_settings_deid_add_rule', name=tpl.name) }}" hx-target="#deid-rules" id="deid-add-form">
    <input class="input" name="segment" placeholder="Segment (e.g., PID)" required style="max-width:7rem" />
    <input class="input" name="field" type="number" min="1" placeholder="Field" required style="max-width:6rem" />
    <input class="input" name="component" type="number" min="1" placeholder="Comp." style="max-width:6rem" />
    <input class="input" name="subcomponent" type="number" min="1" placeholder="Subcomp." style="max-width:8rem" />

    <select class="input" name="action" id="deid-action" style="max-width:14rem" onchange="syncParamControls()">
      <option value="redact">redact</option>
      <option value="mask">mask (param = mask char)</option>
      <option value="hash">hash (param = salt)</option>
      <option value="replace">replace (param = literal)</option>
      <option value="preset">preset (synthetic)</option>
    </select>

    <select class="input" id="param-mode" style="max-width:12rem" onchange="syncParamControls()">
      <option value="preset">Preset</option>
      <option value="free">Free-text</option>
    </select>

    <!-- Preset dropdown -->
    <select class="input" id="param-preset" style="min-width:18rem">
      <option value="name">Name (XPN family^given)</option>
      <option value="birthdate">Birthdate (YYYYMMDD)</option>
      <option value="datetime">Date/Time (YYYYMMDDHHMMSS)</option>
      <option value="gender">Gender (M/F)</option>
      <option value="address">Address (XAD)</option>
      <option value="phone">Phone (XTN)</option>
      <option value="language">Language</option>
      <option value="race">Race</option>
      <option value="mrn">MRN</option>
      <option value="ssn">SSN</option>
      <option value="facility">Facility (ID^Name^Addr)</option>
      <option value="note">Note (NTE)</option>
      <option value="pdf_blob">PDF Blob (JVBER stub)</option>
      <option value="xml_blob">XML Blob (PD94 stub)</option>
    </select>

    <!-- Free text (used by replace/mask/hash or truly custom) -->
    <input class="input" id="param-literal" placeholder="Param (e.g., *, fixed string, hash salt, custom)" style="min-width:18rem" />

    <button class="button">Add</button>
  </form>

  <script>
  function syncParamControls() {
    const action = document.getElementById('deid-action').value;
    const mode   = document.getElementById('param-mode').value;
    const preset = document.getElementById('param-preset');
    const free   = document.getElementById('param-literal');

    if (action === 'preset') {
      document.getElementById('param-mode').disabled = false;
      if (mode === 'preset') {
        preset.style.display = '';
        preset.disabled = false;
        preset.name = 'param';
        free.style.display = 'none';
        free.disabled = true;
        free.name = '';
      } else {
        preset.style.display = 'none';
        preset.disabled = true;
        preset.name = '';
        free.style.display = '';
        free.disabled = false;
        free.name = 'param';
      }
    } else if (action === 'replace' || action === 'mask' || action === 'hash') {
      document.getElementById('param-mode').disabled = true;
      preset.style.display = 'none';
      preset.disabled = true;
      preset.name = '';
      free.style.display = '';
      free.disabled = false;
      free.name = 'param';
    } else {
      document.getElementById('param-mode').disabled = true;
      preset.style.display = 'none';
      preset.disabled = true;
      preset.name = '';
      free.style.display = 'none';
      free.disabled = true;
      free.name = '';
    }
  }
  document.addEventListener('DOMContentLoaded', syncParamControls);
  </script>

  <div class="grid two mt">
    <div>
      <div id="deid-rules">
        {% include "ui/settings/_deid_rules_table.html" %}
      </div>
    </div>

    <aside class="card" style="max-height:60vh; overflow:auto">
      <h3 class="text-h3 mb">How parameters work</h3>
      <ul class="mb">
        <li><b>redact</b>: sets value empty.</li>
        <li><b>mask</b>: replaces each char; <i>Param</i> = mask char (e.g., <code>*</code>).</li>
        <li><b>hash</b>: deterministic 16-char digest; <i>Param</i> = optional salt.</li>
        <li><b>replace</b>: literal string; <i>Param</i> = fixed text.</li>
        <li><b>preset</b>: synthetic; choose a preset or switch to Free-text to enter a preset key manually.</li>
      </ul>
      <h4 class="text-h4 mb">Common presets</h4>
      <ul class="mb">
        <li><code>name</code> → XPN family^given</li>
        <li><code>birthdate</code> → YYYYMMDD</li>
        <li><code>datetime</code> → YYYYMMDDHHMMSS</li>
        <li><code>gender</code> → M/F</li>
        <li><code>address</code> → XAD street^city^state^zip^country</li>
        <li><code>phone</code> → (XXX)XXX-XXXX</li>
        <li><code>mrn</code>, <code>ssn</code>, <code>facility</code>, <code>note</code></li>
        <li><code>pdf_blob</code> / <code>xml_blob</code> → safe stubs</li>
      </ul>
      <p class="muted">Tip: For component/subcomponent-level redaction, set <b>Comp/Subcomp</b> to target only that path.</p>
    </aside>
  </div>
</div>
{% endblock %}

{% extends "layout.html" %}
{% block content %}
<style>
.modal-root { position: fixed; inset: 0; z-index: 1000; }
.modal-backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(1px); }
.modal { position: absolute; inset: 0; display: grid; place-items: center; padding: 1.5rem; }
.modal-card { background: #fff; border-radius: 1rem; padding: 1.25rem 1.5rem; min-width: 720px; max-width: 90vw; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
.modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
</style>

<h1 class="text-h1">De-identify Template — {{ tpl.name }}</h1>

<div class="row gap">
  <a class="button" href="{{ request.url_for('ui_settings_deid_export_json', name=tpl.name) }}">Export JSON</a>
  <a class="button" href="{{ request.url_for('ui_settings_deid_export_csv', name=tpl.name) }}">Export CSV</a>
  <form class="row gap small" hx-post="{{ request.url_for('ui_settings_deid_import_csv', name=tpl.name) }}" hx-target="#deid-rules">
    <input type="file" name="file" accept=".csv" required />
    <button class="button">Import CSV</button>
  </form>
  <form class="row gap small" hx-post="{{ request.url_for('ui_settings_deid_seed_defaults', name=tpl.name) }}" hx-target="#deid-rules">
    <button class="button secondary">Seed defaults</button>
  </form>
  <form class="row gap small" hx-post="{{ request.url_for('ui_settings_deid_delete') }}" hx-target="body" onsubmit="return confirm('Delete template {{ tpl.name }}?')">
    <input type="hidden" name="name" value="{{ tpl.name }}">
    <button class="button danger">Delete template</button>
  </form>
</div>

<div class="card mt">
  <h2 class="text-h2">Rules</h2>
  <div class="row mb">
    <button
      class="button"
      hx-get="{{ request.url_for('ui_settings_deid_new_rule_modal', name=tpl.name) }}"
      hx-target="body"
      hx-swap="beforeend"
    >Add Rule</button>
  </div>

  <div class="grid two mt">
    <div>
      <div id="deid-rules">
        {% include "ui/settings/_deid_rules_table.html" %}
      </div>
    </div>

    <aside class="card" style="max-height:60vh; overflow:auto">
      <h3 class="text-h3 mb">How parameters work</h3>
      <ul class="mb">
        <li><b>redact</b>: sets value empty.</li>
        <li><b>mask</b>: replaces each char; <i>Param</i> = mask char (e.g., <code>*</code>).</li>
        <li><b>hash</b>: deterministic 16-char digest; <i>Param</i> = optional salt.</li>
        <li><b>replace</b>: literal string; <i>Param</i> = fixed text.</li>
        <li><b>preset</b>: synthetic; choose from presets or enter a custom preset key.</li>
        <li><b>regex_replace</b>: JSON param with <code>pattern</code>, <code>repl</code>, <code>flags</code>.</li>
        <li><b>regex_redact</b>: JSON param; matches are masked with <code>*</code>.</li>
        <li><b>dotnet_regex_*</b>: future hook — inert unless <code>ENABLE_DOTNET_REGEX=1</code>.</li>
      </ul>
      <h4 class="text-h4 mb">Common presets</h4>
      <ul class="mb">
        <li><code>name</code> → XPN family^given</li>
        <li><code>birthdate</code> → YYYYMMDD</li>
        <li><code>datetime</code> → YYYYMMDDHHMMSS</li>
        <li><code>gender</code> → M/F</li>
        <li><code>address</code> → XAD street^city^state^zip^country</li>
        <li><code>phone</code> → (XXX)XXX-XXXX</li>
        <li><code>mrn</code>, <code>ssn</code>, <code>facility</code>, <code>note</code></li>
        <li><code>pdf_blob</code> / <code>xml_blob</code> → safe stubs</li>
      </ul>
      <p class="muted">Tip: For component/subcomponent-level redaction, set <b>Comp/Subcomp</b> to target only that path.</p>
    </aside>
  </div>
</div>
{% endblock %}

<div id="val-modal" class="modal-root"
     data-test-endpoint="{{ request.url_for('api_validate_test_check') }}"
     hx-on::after-settle="try { initValModal('#val-modal'); } catch (e) { console.error(e); }">
  <div class="modal-backdrop" onclick="document.getElementById('val-modal').remove()"></div>
  <div class="modal">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="text-h3">Add Validation Check</h3>
        <button class="button ghost" type="button" onclick="document.getElementById('val-modal').remove()">✕</button>
      </div>
      <form
        hx-post="{{ request.url_for('ui_settings_val_add_check', name=tpl.name) }}"
        hx-target="#val-checks"
        hx-on::after-request="document.getElementById('val-modal')?.remove()"
      >
        <div class="grid two">
          <label>Segment
            <input class="input" name="segment" id="vc-seg" placeholder="MSH" required>
          </label>
          <label>Field
            <input class="input" name="field" id="vc-field" type="number" min="1" required>
          </label>
          <label class="row small" style="align-items:center">
            <input type="checkbox" name="required" id="vc-required" checked>
            <span>Required</span>
          </label>
          <label>Pattern (regex)
            <input class="input" name="pattern" id="vc-pattern" placeholder="^ADT\\^A0[14]$">
          </label>
        </div>
        <label class="mt">Allowed values (comma or semicolon separated)
          <input class="input" name="allowed_values" id="vc-allowed" placeholder="ADT^A01, ADT^A04">
        </label>
        <div class="card mt">
          <h4 class="text-h4">Test &amp; Preview</h4>
          <label>Sample HL7 snippet
            <textarea class="input" id="vc-sample" rows="5">MSH|^~\&|S1|F1|R1|D1|202501011200||ADT^A01|MSGID|P|2.5</textarea>
          </label>
          <div class="row mt">
            <button class="button" type="button" data-val-test>Test</button>
          </div>
          <div class="grid two mt">
            <div>
              <h5 class="text-h5">Before (field)</h5>
              <div id="val-before-field" class="diff muted">—</div>
            </div>
            <div>
              <h5 class="text-h5">After (field)</h5>
              <div id="val-after-field" class="diff">—</div>
            </div>
          </div>
          <div class="grid two mt">
            <div>
              <h5 class="text-h5">Line — original</h5>
              <div id="val-msg-before" class="diff">—</div>
            </div>
            <div>
              <h5 class="text-h5">Line — transformed</h5>
              <div id="val-msg-after" class="diff">—</div>
            </div>
          </div>
          <div class="mt">
            <h5 class="text-h5">Validation report</h5>
            <pre id="vc-report" class="mono diff">—</pre>
          </div>
        </div>

        <div class="modal-scroll-controls">
          <button type="button" class="btn" id="val-scroll-down">Scroll down</button>
          <button type="button" class="btn" id="val-scroll-top" hidden>Back to top</button>
        </div>
        <div class="row end mt">
          <button type="button" class="button ghost" onclick="document.getElementById('val-modal').remove()">Cancel</button>
          <button class="button">Save check</button>
        </div>
      </form>
      <style>
        .modal-root{position:fixed;inset:0;z-index:50;}
        .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);backdrop-filter:blur(1px);}
        .modal{position:fixed;inset:0;display:grid;place-items:center;padding:1rem;}
        #val-modal .modal-card{background:var(--card-bg,#0b1220);color:var(--card-fg,#e5e7eb);border-radius:1rem;padding:1rem 1.25rem;width:min(760px,92vw);max-height:72vh;overflow:auto;box-shadow:0 14px 34px rgba(15,23,42,.35);border:1px solid var(--border-strong,#2b2f3a);}
        #val-modal .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;}
        #val-modal .grid.two{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;}
        #val-modal .grid.two>label{display:flex;flex-direction:column;gap:6px;min-width:0;}
        #val-modal .row{display:flex;gap:.5rem;align-items:center;}
        #val-modal .row.end{justify-content:flex-end;}
        #val-modal .row.small{gap:.35rem;}
        #val-modal .input{width:100%;min-width:0;}
        #val-modal .diff{color:var(--text-primary,#e6e9f2);white-space:pre-wrap;background:rgba(15,23,42,.45);border-radius:.5rem;padding:.5rem;min-height:2.25rem;word-break:break-word;}
        #val-modal .modal-scroll-controls{position:sticky;bottom:8px;display:flex;gap:8px;justify-content:flex-end;padding:8px 0;pointer-events:none;}
        #val-modal .modal-scroll-controls .btn{pointer-events:auto;border:1px solid var(--border-strong,#2b2f3a);background:rgba(20,24,31,.75);padding:6px 10px;border-radius:6px;font-size:12px;color:var(--text-primary,#e6e9f2);}
        #val-modal .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
        #val-modal .diff ins.added{color:#ef4444;background:transparent;text-decoration:none;}
        #val-modal .diff del.removed{color:#94a3b8;text-decoration:line-through;}
        #val-modal .diff .same{color:inherit;}
      </style>
    </div>
  </div>
</div>

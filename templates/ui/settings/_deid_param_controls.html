{# Server-rendered parameter controls for De-ID actions.
   Expects: action, param_mode in the context. #}

{% set act  = (action or 'redact')|lower %}
{% set mode = (param_mode or 'preset')|lower %}

<div class="mt">
  {% if act == 'preset' %}
    <div class="grid two">
      <label>Parameter mode
        <select class="input" name="param_mode"
                hx-get="{{ request.url_for('ui_settings_deid_param_controls') }}"
                hx-target="#param-controls"
                hx-vals="js:{ action: (document.getElementById('m-action')?.value || 'preset'), param_mode: this.value }"
                hx-trigger="change"
                hx-swap="innerHTML">
          <option value="preset" {{ 'selected' if mode=='preset' else '' }}>Preset</option>
          <option value="free"   {{ 'selected' if mode=='free'   else '' }}>Free-text</option>
        </select>
      </label>

      {% if mode == 'preset' %}
        <label>Preset key
          <select class="input" name="param_preset">
            {% for opt in ['name','birthdate','datetime','gender','address','phone','language','race','mrn','ssn','facility','note','pdf_blob','xml_blob'] %}
              <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </label>
      {% else %}
        <label>Value / Param
          <input class="input" name="param_free" placeholder="fixed text">
        </label>
      {% endif %}
    </div>

  {% elif act in ['replace','mask','hash'] %}
    <label class="mt">Value / Param
      <input class="input" name="param_free" placeholder="replace→fixed text; mask→mask char; hash→salt">
    </label>

  {% elif act == 'regex_redact' %}
    <label class="mt">Regex pattern
      <input class="input" name="pattern" placeholder="e.g., \\d{6}">
    </label>

  {% elif act == 'regex_replace' %}
    <div class="grid two">
      <label>Regex pattern
        <input class="input" name="pattern" placeholder="e.g., (\\d{3})-(\\d{2})-(\\d{4})">
      </label>
      <label>Replacement
        <input class="input" name="repl" placeholder="***-**-****">
      </label>
    </div>

  {% elif act == 'redact' %}
    <p class="muted">This action has no parameters.</p>

  {% else %}
    <label class="mt">Parameter
      <input class="input" name="param_free" placeholder="parameter value">
    </label>
  {% endif %}
</div>

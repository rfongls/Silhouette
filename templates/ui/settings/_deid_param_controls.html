{% set act = (action or 'redact')|lower %}
{% set mode = (param_mode or 'preset')|lower %}
{% set preset_options = ['name','birthdate','datetime','gender','address','phone','language','race','mrn','ssn','facility','note','pdf_blob','xml_blob'] %}
{% set preset_value = (param_preset or preset_options[0]) %}
{% set free_value = (param_free or '') %}
{% set pattern_value = (pattern or '') %}
{% set repl_value = (repl or '') %}
{% if request.headers.get('HX-Request') %}
  <input type="hidden" name="param_mode" id="m-param-mode" value="{{ mode }}" hx-swap-oob="outerHTML">
{% endif %}
{% if request.headers.get('HX-Request') %}
  <input type="hidden" name="param_mode" id="m-param-mode" value="{{ mode }}" hx-swap-oob="outerHTML">
{% endif %}

<div class="mt">
  {% if act == 'preset' %}
    <div class="grid two">
      <label>Parameter mode
        <select class="input" name="param_mode"
                hx-get="{{ request.url_for('ui_settings_deid_param_controls') }}"
                hx-target="#param-controls"
                hx-include="#deid-modal-form"
                hx-trigger="change"
                hx-swap="innerHTML">
          <option value="preset" {{ 'selected' if mode == 'preset' else '' }}>Preset</option>
          <option value="free" {{ 'selected' if mode == 'free' else '' }}>Free-text</option>
        </select>
      </label>

      {% if mode == 'preset' %}
        <label>Preset key
          <select class="input" name="param_preset">
            {% for opt in preset_options %}
              <option value="{{ opt }}" {{ 'selected' if (preset_value or preset_options[0]) == opt else '' }}>{{ opt }}</option>
            {% endfor %}
          </select>
        </label>
      {% else %}
        <label>Value / Param
          <input class="input" name="param_free" placeholder="e.g., fixed text" value="{{ free_value }}">
        </label>
      {% endif %}
    </div>

  {% elif act in ['replace', 'mask', 'hash'] %}
    <label class="mt">Value / Param
      <input class="input" name="param_free" placeholder="replace→fixed text; mask→mask char; hash→salt" value="{{ free_value }}">
    </label>

  {% elif act == 'regex_redact' %}
    <label class="mt">Regex pattern
      <input class="input" name="pattern" placeholder="e.g., \\d{6}" value="{{ pattern_value }}">
    </label>

  {% elif act == 'regex_replace' %}
    <div class="grid two">
      <label>Regex pattern
        <input class="input" name="pattern" placeholder="e.g., (\\d{3})-(\\d{2})-(\\d{4})" value="{{ pattern_value }}">
      </label>
      <label>Replacement
        <input class="input" name="repl" placeholder="***-**-****" value="{{ repl_value }}">
      </label>
    </div>

  {% else %}
    <p class="muted">This action has no parameters.</p>
  {% endif %}
</div>

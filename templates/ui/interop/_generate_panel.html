<section class="card" id="gen-card">
  <div class="card-header">
    <h3 class="card-title">Generate Message</h3>
    <div class="toolbar"></div>
  </div>
  <div class="card-body">
<!-- Form uses HTMX (API) and falls back to HTML (UI) when JS is disabled -->
{% set root = request.scope.get('root_path', '') %}
<form id="gen-form"
      method="post"
      action="{{ urls.ui_generate | default(root ~ '/ui/interop/generate', true) }}"
      autocomplete="off"
      novalidate
      hx-post="{{ urls.api_generate | default(root ~ '/api/interop/generate', true) }}"
      hx-encoding="application/x-www-form-urlencoded"
      hx-target="#gen-output"
      hx-swap="textContent"
      hx-headers='{"Accept":"text/plain"}'>
    <div class="row gap">
      <label>Version</label>
      <select name="version" class="input hl7-version-select" id="gen-version"
              data-hx-refresh-target="1"
              onchange="window.InteropUI.fillDatalist('gen')">
        <option value="hl7-v2-3">HL7 v2.3</option>
        <option value="hl7-v2-4" selected>HL7 v2.4</option>
        <option value="hl7-v2-5">HL7 v2.5</option>
      </select>
      <label>Template</label>
      <input class="input grow"
             id="gen-trigger-typed"
             name="trigger"
             list="gen-trigger-datalist"
             placeholder="Type a trigger (e.g., ADT_A01)"
             onfocus="window.InteropUI.fillDatalist('gen')"
             oninput="window.InteropUI.syncTemplateRelpath('gen')"
             onchange="window.InteropUI.syncTemplateRelpath('gen')"/>
      <datalist id="gen-trigger-datalist"></datalist>
      <input type="hidden" name="template_relpath" id="gen-template-relpath" />
    </div>

    <p id="gen-template-hint" class="muted small mt" data-empty="No template selected.">No template selected.</p>

    <div class="row gap mt">
      <input class="input" type="number" name="count" id="gen-count" min="1" max="10000" placeholder="count (default 1)" />
      <input class="input" type="number" name="seed" id="gen-seed" placeholder="seed (optional)"/>
      <label><input type="checkbox" name="ensure_unique" checked/> Unique IDs</label>
      <label><input type="checkbox" name="include_clinical"/> Enrich clinical (DG1/AL1)</label>
      <label><input type="checkbox" name="deidentify"/> De-identify</label>
    </div>

    <div class="row gap mt">
      <button type="submit" id="btn-generate" class="btn btn-primary">Generate</button>
    </div>
  </form>
  <div class="mt">
    <pre id="gen-output" class="codepane scrollbox tall" aria-label="Generated HL7 output"></pre>
  </div>
  <div class="action-cards">
    <div class="action-card">
      <h4>Run Next Pipeline → De‑Identify</h4>
      <p class="micro muted">Use the generated HL7 as input to De‑Identify.</p>
      <button class="btn" type="button" onclick="window.InteropUI.runDeidFromGenerate()">Run De‑Identify</button>
    </div>
    <div class="action-card">
      <h4>Run Validation Pipeline → Validate</h4>
      <p class="micro muted">Send the generated HL7 to Validate and review results.</p>
      <button class="btn" type="button" onclick="window.InteropUI.runValidateFromGenerate()">Run Validate</button>
    </div>
    <div class="action-card">
      <h4>Run Full FHIR Pipeline → HL7→FHIR</h4>
      <p class="micro muted">Open the HL7→FHIR pipeline, prefilled with your generated HL7.</p>
      <button class="btn" type="button" onclick="window.InteropUI.openPipelineWithText(window.InteropUI.getGenText())">Open HL7→FHIR</button>
    </div>
  </div>
  <noscript>
    <p class="muted mt">JavaScript is disabled. Submitting will open a results page.</p>
  </noscript>
  </div>
</section>

{% set root = request.scope.get('root_path', '') %}
<section id="generate-panel" class="panel interop-panel interop-panel-generate"
         data-accordion data-open="1" aria-labelledby="generate-header">
  <header id="generate-header" class="row gap" data-acc-toggle aria-expanded="true"
          aria-controls="gen-body" style="justify-content:space-between;align-items:center">
    <h3 class="text-h3" style="margin:0">Generate Messages</h3>
    <span class="acc-right muted small"><span data-acc-label>collapse</span></span>
  </header>
  <div id="gen-body" class="module-body" data-acc-body>

    <form id="gen-form"
          method="post" autocomplete="off" novalidate
          action="{{ urls.ui_generate | default(root ~ '/ui/interop/generate', true) }}"
          hx-post="{{ urls.api_generate | default(root ~ '/api/interop/generate', true) }}"
          hx-encoding="application/x-www-form-urlencoded"
          hx-target="#gen-output"
          hx-swap="textContent"
          hx-headers='{"Accept":"text/plain"}'
          hx-on::afterRequest="window.InteropUI.onGenerateComplete(event)">
      <div class="row gap">
        <label for="gen-version">Version</label>
        <select name="version" class="input hl7-version-select" id="gen-version"
                data-hx-refresh-target="1"
                onchange="window.InteropUI.fillDatalist('gen')">
          <option value="hl7-v2-3">HL7 v2.3</option>
          <option value="hl7-v2-4" selected>HL7 v2.4</option>
          <option value="hl7-v2-5">HL7 v2.5</option>
        </select>
        <label for="gen-trigger-typed">Template</label>
        <input class="input grow" id="gen-trigger-typed" name="trigger" list="gen-trigger-datalist"
               placeholder="Type a trigger (e.g., ADT_A01)"
               onfocus="window.InteropUI.fillDatalist('gen')"
               oninput="window.InteropUI.syncTemplateRelpath('gen')"
               onchange="window.InteropUI.syncTemplateRelpath('gen')" />
        <datalist id="gen-trigger-datalist"></datalist>
        <input type="hidden" name="template_relpath" id="gen-template-relpath" />
      </div>
      <p id="gen-template-hint" class="muted small mt" data-empty="No template selected.">No template selected.</p>
      <div class="row gap mt">
        <input class="input" type="number" name="count" id="gen-count" min="1" max="10000" placeholder="count (default 1)" />
        <input class="input" type="number" name="seed" id="gen-seed" placeholder="seed (optional)" />
        <label><input type="checkbox" name="ensure_unique" checked /> Unique IDs</label>
        <label><input type="checkbox" name="include_clinical" /> Enrich clinical (DG1/AL1)</label>
        <label><input type="checkbox" name="deidentify" /> Deâ€‘identify</label>
      </div>
      <div class="mt"><button class="btn" type="submit" data-action="generate">Generate</button></div>
    </form>
    <pre id="gen-output" class="textarea-output codepane mt" aria-live="polite" aria-label="Generated HL7 output"></pre>
    <div id="gen-run-tray" class="action-tray" hidden>
      <div class="action-tray-header">
        <h4>Run next pipeline step</h4>
        <p>Select a follow-up task to continue the workflow.</p>
      </div>
      <div class="action-cards">
        <button class="action-card pipeline-run" type="button" data-run-to="deid">
          <strong>ðŸ”’ Deâ€‘identify</strong>
          <small>Prefill the Deâ€‘identify card with this message.</small>
        </button>
        <button class="action-card pipeline-run" type="button" data-run-to="validate">
          <strong>âœ“ Validate</strong>
          <small>Send the generated HL7 to the Validate card.</small>
        </button>
        <a class="action-card pipeline-run"
           href="{{ urls.ui_pipeline | default(root ~ '/ui/interop/pipeline', true) }}"
           data-open-pipeline-from="generate"
           data-run-to="pipeline">
          <strong>ðŸ”„ HL7 â†’ FHIR Pipeline</strong>
          <small>Launch the pipeline with this generated message.</small>
        </a>
      </div>
    </div>
  </div>
</details>

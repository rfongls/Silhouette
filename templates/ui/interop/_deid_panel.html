{% set root = request.scope.get('root_path', '') %}
{% if urls is not defined %}{% set urls = {} %}{% endif %}
{% set api_deidentify = urls.api_deidentify | default(root ~ '/api/interop/deidentify', true) %}
{% if '?' in api_deidentify %}
  {% set api_deidentify_plain = api_deidentify ~ '&format=txt' %}
{% else %}
  {% set api_deidentify_plain = api_deidentify ~ '?format=txt' %}
{% endif %}

<form id="deid-form"
      class="mt"
      method="post"
      action="{{ urls.ui_deidentify | default(root ~ '/ui/interop/deidentify', true) }}"
      hx-post="{{ api_deidentify_plain }}"
      hx-encoding="application/x-www-form-urlencoded"
      hx-headers='{"Accept":"text/plain"}'
      hx-target="#deid-output"
      hx-swap="textContent">
  <textarea id="deid-text"
            name="text"
            class="input textarea-output"
            placeholder="Paste HL7 to de-identify"></textarea>
  <div class="row gap mt">
    <input class="input" id="deid-seed" name="seed" placeholder="seed (optional)" />
    <button id="deid-run" class="btn" type="submit">De‑identify</button>
  </div>
</form>

<div id="deid-report"
     class="mt"
     hx-post="{{ urls.api_deidentify_summary | default(root ~ '/api/interop/deidentify/summary', true) }}"
     hx-include="#deid-text,#deid-seed"
     hx-trigger="htmx:afterRequest from:#deid-form"
     hx-headers='{"Accept":"text/html"}'
     hx-swap="innerHTML">
  <details class="mini-report">
    <summary>De-identification report</summary>
    <div class="muted small">Run de-identify to see what fields changed.</div>
  </details>
</div>

<pre id="deid-output" class="codepane limit10 scrollbox" aria-live="polite"></pre>

<div class="action-tray mt">
  <div class="action-card" onclick="window.InteropUI.runNextFromDeid('validate')">
    <strong>Run Next Pipeline → Validate</strong>
    <small>Use the de‑identified HL7 for validation.</small>
  </div>
  <div class="action-card" onclick="window.InteropUI.runNextFromDeid('mllp')">
    <strong>Run MLLP Pipeline</strong>
    <small>Prefill the MLLP card with the de‑identified message.</small>
  </div>
  <div class="action-card" onclick="window.InteropUI.runTo('fhir')">
    <strong>Run Full FHIR Pipeline → HL7 → FHIR</strong>
    <small>Open the transport card with FHIR translation enabled.</small>
  </div>
</div>

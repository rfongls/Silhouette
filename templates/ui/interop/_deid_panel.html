{% set root = request.scope.get('root_path', '') %}
{% if urls is not defined %}{% set urls = {} %}{% endif %}
{% set api_deidentify = urls.api_deidentify | default(root ~ '/api/interop/deidentify', true) %}
{% if '?' in api_deidentify %}
  {% set api_deidentify_plain = api_deidentify ~ '&format=txt' %}
{% else %}
  {% set api_deidentify_plain = api_deidentify ~ '?format=txt' %}
{% endif %}

<section id="deid-panel" class="interop-panel interop-panel-deid">
  <form id="deid-form"
        class="mt"
        method="post"
        action="{{ urls.ui_deidentify | default(root ~ '/ui/interop/deidentify', true) }}"
        hx-post="{{ api_deidentify_plain }}"
        hx-encoding="application/x-www-form-urlencoded"
        hx-headers='{"Accept":"text/plain"}'
        hx-target="#deid-output"
        hx-swap="textContent"
        hx-on::afterSwap="window.InteropUI.onDeidentifyComplete(event)">
    <textarea id="deid-text"
              name="text"
              class="input textarea-output"
              placeholder="Paste HL7 to de-identify"></textarea>
    <div class="row gap mt">
      <input class="input" id="deid-seed" name="seed" placeholder="seed (optional)" />
      <button id="deid-run" class="btn" type="submit" data-action="deidentify">Deâ€‘identify</button>
    </div>
  </form>

  <div id="deid-report"
       class="mt"
       hx-post="{{ urls.api_deidentify_summary | default(root ~ '/api/interop/deidentify/summary', true) }}"
       hx-include="#deid-text,#deid-seed"
       hx-trigger="htmx:afterRequest from:#deid-form"
       hx-headers='{"Accept":"text/html"}'
       hx-swap="innerHTML">
    <details class="mini-report">
      <summary>De-identification report</summary>
      <div class="muted small">Run de-identify to see what fields changed.</div>
    </details>
  </div>

  <pre id="deid-output" class="codepane limit10 scrollbox" aria-live="polite"></pre>

  <div id="deid-run-tray" class="action-tray mt" hidden>
    <div class="action-tray-header">
      <h4>Next steps after Deâ€‘ID</h4>
      <p>Choose what to do with the deâ€‘identified message.</p>
    </div>
    <div class="action-cards">
      <a class="action-card" href="#" onclick="window.InteropUI.runNextFromDeid('validate'); return false;">
        <strong>âœ“ Validate</strong>
        <small>Ensure structural correctness.</small>
      </a>
      <a class="action-card" href="#" onclick="window.InteropUI.openPipelineFrom('deid'); return false;">
        <strong>ðŸ”„ HL7 â†’ FHIR Pipeline</strong>
        <small>Launch the pipeline with the scrubbed HL7.</small>
      </a>
      <a class="action-card" href="#" onclick="window.InteropUI.runNextFromDeid('mllp'); return false;">
        <strong>ðŸ“¤ Send via MLLP</strong>
        <small>Prefill transport with this deâ€‘identified message.</small>
      </a>
    </div>
  </div>
</section>

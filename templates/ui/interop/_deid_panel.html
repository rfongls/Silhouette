{% set root = request.scope.get('root_path', '') %}
{% if urls is not defined %}{% set urls = {} %}{% endif %}
{% set api_deidentify = (urls.api_deidentify | default(root ~ '/api/interop/deidentify', true)) | string %}
{% set deid_options = deid_templates if deid_templates is defined and deid_templates else [] %}
{% set default_deid_template = 'default' if 'default' in deid_options else (deid_options[0] if deid_options else '') %}
{% if '?' in api_deidentify %}
  {% set api_deidentify_plain = api_deidentify ~ '&format=txt' %}
{% else %}
  {% set api_deidentify_plain = api_deidentify ~ '?format=txt' %}
{% endif %}

<section id="deid-panel" class="panel interop-panel interop-panel-deid" data-accordion data-open="0" data-module="deid">
  <header class="row gap" data-acc-toggle aria-expanded="false" style="justify-content:space-between;align-items:center;cursor:pointer">
    <h3 class="text-h3" style="margin:0">Deâ€‘identify</h3>
    <span class="toggle-label"><span class="when-closed">expand</span><span class="when-open">collapse</span></span>
  </header>
  <div id="deid-body" class="panel-body" data-acc-body>
    <form id="deid-form"
          class="mt"
          method="post"
          action="{{ urls.ui_deidentify | default(root ~ '/ui/interop/deidentify', true) }}"
          hx-post="{{ api_deidentify_plain }}"
          hx-encoding="application/x-www-form-urlencoded"
          hx-headers='{"Accept":"text/plain"}'
          hx-target="#deid-output"
          hx-swap="textContent"
          hx-on::afterSwap="window.InteropUI.onDeidentifyComplete(event)">
      <div class="grid two">
        <label>Template
          <select id="deid-template" name="deid_template" class="input">
            {% for name in deid_options %}
              <option value="{{ name }}" {% if name == default_deid_template %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="row gap small" style="align-items:center">
          <input type="checkbox" id="deid-apply-baseline" name="apply_baseline" />
          <span>Use default rules (baseline)</span>
        </label>
      </div>

      <textarea id="deid-text"
                name="text"
                class="input textarea-output mt"
                rows="8"
                placeholder="Paste HL7 to de-identify"></textarea>

      <div class="row gap mt">
        <input class="input" id="deid-seed" name="seed" placeholder="seed (optional)" />
        <button id="deid-run" class="button" type="submit" data-action="deidentify">Run De-identify</button>
      </div>
    </form>

    <pre id="deid-output" class="codepane limit10 scrollbox mt" aria-live="polite"></pre>

    <div id="deid-report"
         class="card mt"
         hx-post="{{ urls.api_deidentify_summary | default(root ~ '/api/interop/deidentify/summary', true) }}"
         hx-include="#deid-text,#deid-seed,#deid-template,#deid-apply-baseline"
         hx-trigger="htmx:afterRequest from:#deid-form"
         hx-headers='{"Accept":"text/html"}'
         hx-swap="innerHTML"
         hx-on::afterSwap="window.InteropUI && window.InteropUI.onDeidentifySummary && window.InteropUI.onDeidentifySummary()">
      <details class="mini-report">
        <summary>De-identification results</summary>
        <div class="muted small">Run de-identify to see what fields changed.</div>
      </details>
    </div>

    <div id="deid-run-tray" class="action-tray mt" hidden>
      <div class="action-tray-header">
        <h4>Next steps after Deâ€‘ID</h4>
        <p>Choose what to do with the deâ€‘identified message.</p>
      </div>
      <div class="action-cards">
        <button class="action-card pipeline-run" type="button" data-run-to="validate" title="Open Validate with this message">
          <strong>âœ“ Validate</strong>
          <small>Ensure structural correctness.</small>
        </button>
        <button class="action-card pipeline-run" type="button" data-run-to="mllp">
          <strong>ðŸ“¤ Send via MLLP</strong>
          <small>Deliver and view ACK.</small>
        </button>
        <button class="action-card pipeline-run" type="button" data-run-to="translate">
          <strong>ðŸ”„ HL7 â†’ FHIR</strong>
          <small>Translate for downstream apps.</small>
        </button>
      </div>
    </div>
  </div>
</section>

{% set root = request.scope.get('root_path', '') %}
{% if urls is not defined %}{% set urls = {} %}{% endif %}

<textarea id="deid-text"
          name="text"
          class="input textarea-output"
          placeholder="Paste HL7 to de-identify"></textarea>

<form id="deid-form"
      class="row gap mt"
      method="post"
      hx-post="{{ urls.ui_deidentify | default(root ~ '/api/interop/deidentify', true) }}"
      hx-encoding="application/x-www-form-urlencoded"
      hx-include="#deid-text,#deid-seed"
      hx-headers='{"Accept":"text/plain"}'
      hx-target="#deid-output"
      hx-swap="textContent">
  <input class="input" id="deid-seed" name="seed" placeholder="seed (optional)" />
  <button id="deid-run" class="btn" type="submit">De‑identify</button>
</form>

<div id="deid-report"
     class="mt"
     hx-post="{{ root }}/api/interop/deidentify/summary"
     hx-include="#deid-text,#deid-seed"
     hx-trigger="htmx:afterRequest from:#deid-form"
     hx-headers='{"Accept":"text/html"}'
     hx-swap="innerHTML">
  <details class="mini-report">
    <summary>De-identification report</summary>
    <div class="muted small">Run de-identify to see what fields changed.</div>
  </details>
</div>

<pre id="deid-output" class="codepane limit10 scrollbox" aria-live="polite"></pre>

<div class="action-tray mt">
  <div class="action-card" onclick="window.InteropUI.runNextFromDeid('validate')">
    <strong>Run Next Pipeline → Validate</strong>
    <small>Use the de‑identified HL7 for validation.</small>
  </div>
  <div class="action-card" onclick="window.InteropUI.runNextFromDeid('mllp')">
    <strong>Run MLLP Pipeline</strong>
    <small>Prefill the MLLP card with the de‑identified message.</small>
  </div>
  <div class="action-card" onclick="window.InteropUI.runTo('fhir')">
    <strong>Run Full FHIR Pipeline → HL7 → FHIR</strong>
    <small>Open the transport card with FHIR translation enabled.</small>
  </div>
</div>

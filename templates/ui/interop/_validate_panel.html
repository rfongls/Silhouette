{% set root = request.scope.get('root_path', '') %}
{% set validate_api = urls.api_validate | default(root ~ '/api/interop/validate', true) %}
{% if '?' in validate_api %}
  {% set validate_api = validate_api ~ '&format=html' %}
{% else %}
  {% set validate_api = validate_api ~ '?format=html' %}
{% endif %}
{% set val_options = val_templates if val_templates is defined and val_templates else [] %}
{% set default_val_template = 'default' if 'default' in val_options else (val_options[0] if val_options else '') %}
<details id="validate-panel" class="interop-panel interop-panel-validate" open>
  <summary aria-expanded="false">
    <span class="text-h3" style="margin:0">Validate Message</span>
    <span class="toggle-label"><span class="when-closed">expand</span><span class="when-open">collapse</span></span>
  </summary>
  <div id="val-body" class="panel-body">
    <form id="validate-form"
          method="post"
          action="{{ urls.ui_validate | default(root ~ '/ui/interop/validate', true) }}"
          hx-post="{{ validate_api }}"
          hx-target="#validate-report"
          hx-swap="innerHTML"
          hx-headers='{"Accept":"text/html"}'
          hx-on::afterSwap="window.InteropUI.onValidateComplete(event)">
      <input type="hidden" name="format" value="html" />
      <label class="row gap small">
        <span>Template</span>
        <select name="val_template" id="val-template" class="input">
          {% for name in val_options %}
            <option value="{{ name }}" {% if name == default_val_template %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </label>
      <textarea class="input textarea-output" id="val-text" name="message" placeholder="Paste HL7 to validate"></textarea>
      <div class="row gap mt">
        <input class="input" type="text" name="profile" placeholder="profile/workbook (optional)" />
        <button class="btn" type="submit" data-action="validate">Validate</button>
      </div>
    </form>
    <div class="form-row mt">
      <button class="btn btn-secondary btn-sm" id="print-validate-report" type="button">Print report</button>
    </div>
    <div id="validate-report" class="mt">
      <p class="muted">Run validation to see a report.</p>
    </div>
  </div>
</details>

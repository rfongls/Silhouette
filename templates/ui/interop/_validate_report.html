<section id="validate-report" class="validate-report" data-val-root hx-swap-oob="outerHTML">
  {% set _r = r if r is defined else None %}
  {% set _issues = (_r.issues if _r is not none else (issues if issues is defined else [])) %}
  {% set _issues = _issues or [] %}
  {% set _counts = (_r.counts if _r is not none else (counts if counts is defined else {})) %}
  {% set _counts = _counts or {} %}
  {% set _summary_rows = (_r.summary_rows if _r is not none else (summary_rows if summary_rows is defined else [])) %}
  {% set _summary_rows = _summary_rows or [] %}
  {% set _seg_opts = (_r.segment_options if _r is not none else (segment_options if segment_options is defined else [])) %}
  {% set _seg_opts = _seg_opts or [] %}
  {% set _total_msgs = r.msg_total or r.total_messages or r.total or r.message_count or 1 %}
  {% set _total_msgs = _total_msgs | int %}
  {% set _raw_candidate = (_r.raw | default(None) if _r is not none else None) %}
  {% set _raw = _raw_candidate if _raw_candidate is not none else (raw if raw is defined else {}) %}
  {% set _validated_candidate = (_r.validated_message | default(None) if _r is not none else None) %}
  {% set _validated_message = _validated_candidate if _validated_candidate is not none else (validated_message if validated_message is defined else '') %}
  {% set _vf = vf if vf is defined else {} %}
  {% set _vf_sev = (_vf.sev or _vf.severity or 'error') | lower %}
  {% if _vf_sev in ['errors', 'error', 'err'] %}
    {% set _vf_sev = 'error' %}
  {% elif _vf_sev in ['warnings', 'warn'] %}
    {% set _vf_sev = 'warning' %}
  {% elif _vf_sev in ['passes', 'ok', 'info', 'passed'] %}
    {% set _vf_sev = 'passed' %}
  {% elif _vf_sev not in ['error', 'warning', 'passed', 'all'] %}
    {% set _vf_sev = 'all' %}
  {% endif %}
  {% set _vf_seg = (_vf.seg or 'all') %}
  {% set _vf_q = _vf.q or '' %}

  <header class="validate-report__header" style="display:flex;align-items:center;justify-content:space-between;gap:0.75rem">
    <h4 class="text-h3" style="margin:0">Validation report</h4>
    <div class="validate-report__counts" style="display:flex;flex-wrap:wrap;gap:0.5rem">
      <button type="button" class="chip" data-vf="passed" style="background:#10b981;color:#0b1e15">Passed: {{ _counts.ok | default(0) }}</button>
      <button type="button" class="chip" data-vf="error" style="background:#ef4444;color:#250101">Errors: {{ _counts.errors | default(0) }}</button>
      <button type="button" class="chip" data-vf="all" style="background:#475569;color:#e5e7eb">Show all</button>
    </div>
  </header>

  {% if (_counts.errors | default(0)) or (_counts.ok | default(0)) or (_counts.warnings | default(0)) %}
    <p class="text-small" style="margin-top:0.5rem">
      Found {{ _counts.errors | default(0) }} error{{ 's' if (_counts.errors | default(0)) != 1 else '' }}
      and {{ _counts.ok | default(0) }} successful validation{{ 's' if (_counts.ok | default(0)) != 1 else '' }}.
    </p>
  {% endif %}

  <div class="card mt" style="padding:.5rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">
    <label class="small">Severity
      <select class="input" data-role="val-filter-sev" data-initial="{{ _vf_sev }}" style="min-width:8rem">
        <option value="all">All</option>
        <option value="passed">Passed</option>
        <option value="error" selected>Error</option>
        <option value="warning">Warning</option>
      </select>
    </label>
    <label class="small">Segment
      <select class="input" data-role="val-filter-seg" data-initial="{{ _vf_seg }}" style="min-width:8rem">
        <option value="all">All</option>
        {% for seg in _seg_opts %}
          <option value="{{ seg | e }}">{{ seg }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="small" style="flex:1 1 240px">Search
      <input class="input" data-role="val-filter-text" data-initial="{{ _vf_q }}" value="{{ _vf_q }}" placeholder="Filter by rule, message, or valueâ€¦" />
    </label>
    <button type="button" class="btn btn-xs" data-role="val-filter-reset" style="margin-left:auto">Reset filters</button>
    <span class="muted small">Across {{ _total_msgs }} message{{ '' if _total_msgs == 1 else 's' }}. Unique rows are de-duplicated by rule.</span>
  </div>

  <div class="scrollbox" style="margin-top:0.75rem">
    <table class="validate-report__table" style="width:100%;border-collapse:collapse;font-size:0.875rem">
      <thead>
        <tr style="text-align:left;border-bottom:1px solid var(--color-border, #d1d5db)">
          <th style="padding:0.5rem">Severity</th>
          <th style="padding:0.5rem">Rule / Code</th>
          <th style="padding:0.5rem">Segment</th>
          <th style="padding:0.5rem">Field</th>
          <th style="padding:0.5rem">Comp</th>
          <th style="padding:0.5rem">Subcomp</th>
          <th style="padding:0.5rem">Value</th>
          <th style="padding:0.5rem">Message</th>
          <th style="padding:0.5rem">Count</th>
          <th style="padding:0.5rem">Total</th>
          <th style="padding:0.5rem">%</th>
        </tr>
      </thead>
      <tbody data-role="val-summary-body">
        {% set _has_rows = _summary_rows | length > 0 %}
        {% for row in _summary_rows %}
          {% set _sev = (row.severity or 'error') | lower %}
          {% if _sev in ['ok', 'info'] %}
            {% set _sev = 'passed' %}
          {% endif %}
          {% set _segment = (row.segment or '') | trim %}
          {% set _segment_lower = _segment | lower %}
          {% set _field = row.field %}
          {% set _component = row.component %}
          {% set _subcomponent = row.subcomponent %}
          {% set _count = row.count or 0 %}
          {% set _total = row.total or _total_msgs %}
          {% set _pct = row.pct or 0 %}
          {% set _values = row.shown_values or '' %}
          {% set _extra = row.extra_values or 0 %}
          {% set _message = row.message or '' %}
          {% set _search = row.search_text or '' %}
          <tr
            data-role="val-row"
            data-severity="{{ _sev }}"
            data-segment="{{ _segment_lower | e }}"
            data-segment-raw="{{ _segment | e }}"
            data-text="{{ _search | e }}"
          >
            <td style="padding:0.5rem">
              {% if _sev == 'passed' %}Passed{% elif _sev == 'warning' %}Warning{% else %}Error{% endif %}
            </td>
            <td style="padding:0.5rem"><code class="mono">{{ row.code or 'â€”' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ _segment or 'â€”' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ _field if _field is not none and _field != '' else 'â€”' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ _component if _component is not none and _component != '' else 'â€”' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ _subcomponent if _subcomponent is not none and _subcomponent != '' else 'â€”' }}</code></td>
            <td style="padding:0.5rem">
              {% if _values %}{{ _values }}{% else %}â€”{% endif %}
              {% if _extra and _extra > 0 %} (+{{ _extra }} more){% endif %}
            </td>
            <td style="padding:0.5rem">{{ _message or 'â€”' }}</td>
            <td style="padding:0.5rem">{{ _count }}</td>
            <td style="padding:0.5rem">{{ _count }}/{{ _total }}</td>
            <td style="padding:0.5rem">{{ _pct }}%</td>
          </tr>
        {% endfor %}
        <tr data-role="val-empty" {% if _has_rows %}style="display:none"{% endif %}>
          <td colspan="11" class="muted" style="padding:.75rem">No issues to display.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <details class="mt" style="margin-top:0.75rem">
    <summary class="text-small">Show raw JSON</summary>
    <pre class="codepane mono" style="margin-top:0.5rem">{{ _raw | tojson(indent=2) }}</pre>
  </details>

  <script type="application/json" data-role="val-issues" data-total="{{ _total_msgs }}">{{ _issues | tojson }}</script>

  <script>
    (function (script) {
      const root = script.closest('[data-val-root]');
      if (!root) return;
      const dataEl = root.querySelector('[data-role="val-issues"]');
      const body = root.querySelector('[data-role="val-summary-body"]');
      const emptyRow = root.querySelector('[data-role="val-empty"]');
      if (!dataEl || !body) return;

      let issues = [];
      try {
        issues = JSON.parse(dataEl.textContent || '[]') || [];
      } catch (err) {
        issues = [];
      }
      const TOTAL = parseInt(dataEl.dataset.total || '1', 10) || 1;

      const severitySelect = root.querySelector('[data-role="val-filter-sev"]');
      const segmentSelect = root.querySelector('[data-role="val-filter-seg"]');
      const searchInput = root.querySelector('[data-role="val-filter-text"]');
      const resetButton = root.querySelector('[data-role="val-filter-reset"]');
      const chips = Array.from(root.querySelectorAll('.validate-report__counts .chip[data-vf]'));
      if (!severitySelect || !segmentSelect || !searchInput) return;

      const normalize = (item) => {
        const clean = (value) => (value === null || value === undefined ? '' : String(value).trim());
        const cleanZeroable = (value) => (value === 0 ? '0' : clean(value));
        if (!item || typeof item !== 'object') {
          return {
            severity: 'error',
            code: '',
            segment: '',
            field: '',
            component: '',
            subcomponent: '',
            value: '',
            message: '',
          };
        }
        const severity = clean(item.severity || item.status || 'error').toLowerCase();
        const normalizedSeverity = severity.includes('warn')
          ? 'warning'
          : (severity.includes('ok') || severity.includes('pass') || severity.includes('info'))
            ? 'passed'
            : 'error';
        return {
          severity: normalizedSeverity,
          code: clean(item.code || item.rule || item.id || ''),
          segment: clean(item.segment || ''),
          field: cleanZeroable(item.field ?? ''),
          component: cleanZeroable(item.component ?? ''),
          subcomponent: cleanZeroable(item.subcomponent ?? ''),
          value: clean(item.value || item.actual || item.expected || item.received || ''),
          message: clean(item.message || ''),
        };
      };

      const segments = new Set();
      let builtRows = Array.from(body.querySelectorAll('[data-role="val-row"]'));

      if (!builtRows.length) {
        const rowsMap = new Map();

        issues.forEach((raw) => {
          const row = normalize(raw);
          const key = [
            row.severity,
            row.code,
            row.segment,
            row.field,
            row.component,
            row.subcomponent,
            row.message,
          ].join('|');
          if (!rowsMap.has(key)) {
            rowsMap.set(key, {
              severity: row.severity,
              code: row.code,
              segment: row.segment,
              field: row.field,
              component: row.component,
              subcomponent: row.subcomponent,
              message: row.message,
              values: new Set(),
              count: 0,
            });
          }
          const bucket = rowsMap.get(key);
          if (row.value) bucket.values.add(row.value);
          bucket.count += 1;
        });

        body.innerHTML = '';

        const sortedBuckets = Array.from(rowsMap.values()).sort((a, b) => {
          const order = (sev) => (sev === 'error' ? 0 : sev === 'warning' ? 1 : 2);
          return order(a.severity) - order(b.severity)
            || (a.segment || '').localeCompare(b.segment || '')
            || (parseInt(a.field || '0', 10) - parseInt(b.field || '0', 10))
            || (a.code || '').localeCompare(b.code || '');
        });

        builtRows = sortedBuckets.map((bucket) => {
          const values = Array.from(bucket.values);
          const shown = values.slice(0, 8);
          const extraCount = values.length - shown.length;
          const extra = extraCount > 0 ? ` (+${extraCount} more)` : '';
          const severityLabel = bucket.severity === 'passed'
            ? 'Passed'
            : bucket.severity === 'warning'
              ? 'Warning'
              : 'Error';
          const tr = document.createElement('tr');
          tr.dataset.role = 'val-row';
          tr.dataset.severity = bucket.severity;
          tr.dataset.segment = (bucket.segment || '').trim().toLowerCase();
          tr.dataset.segmentRaw = bucket.segment || '';
          tr.dataset.text = [
            bucket.code,
            bucket.segment,
            bucket.field,
            bucket.component,
            bucket.subcomponent,
            values.join(' '),
            bucket.message,
          ]
            .join(' ')
            .toLowerCase();
          tr.innerHTML = `
            <td style="padding:0.5rem">${severityLabel}</td>
            <td style="padding:0.5rem"><code class="mono">${bucket.code || 'â€”'}</code></td>
            <td style="padding:0.5rem"><code class="mono">${bucket.segment || 'â€”'}</code></td>
            <td style="padding:0.5rem"><code class="mono">${bucket.field || 'â€”'}</code></td>
            <td style="padding:0.5rem"><code class="mono">${bucket.component || 'â€”'}</code></td>
            <td style="padding:0.5rem"><code class="mono">${bucket.subcomponent || 'â€”'}</code></td>
            <td style="padding:0.5rem">${shown.length ? shown.join(', ') : 'â€”'}${extra}</td>
            <td style="padding:0.5rem">${bucket.message || 'â€”'}</td>
            <td style="padding:0.5rem">${bucket.count}</td>
            <td style="padding:0.5rem">${bucket.count}/${TOTAL}</td>
            <td style="padding:0.5rem">${TOTAL ? Math.round((bucket.count / TOTAL) * 100) : 0}%</td>
          `;
          body.appendChild(tr);
          return tr;
        });

        if (!builtRows.length && emptyRow) {
          emptyRow.style.display = '';
          body.appendChild(emptyRow);
        } else if (emptyRow) {
          emptyRow.style.display = 'none';
          body.appendChild(emptyRow);
        }
      }

      builtRows.forEach((tr) => {
        const segRaw = tr.dataset.segmentRaw || '';
        if (segRaw) segments.add(segRaw);
      });

      if (emptyRow && builtRows.length) {
        emptyRow.style.display = 'none';
      }

      const segmentInitial = segmentSelect.dataset.initial || 'all';
      const severityInitial = severitySelect.dataset.initial || 'error';
      const searchInitial = searchInput.dataset.initial || '';

      const existingSegments = new Set(Array.from(segmentSelect.options).map((opt) => opt.value));
      Array.from(segments)
        .sort((a, b) => a.localeCompare(b))
        .forEach((segment) => {
          if (!segment || existingSegments.has(segment)) return;
          const opt = document.createElement('option');
          opt.value = segment;
          opt.textContent = segment;
          segmentSelect.appendChild(opt);
        });

      if (Array.from(segmentSelect.options).some((opt) => opt.value === segmentInitial)) {
        segmentSelect.value = segmentInitial;
      }
      if (Array.from(severitySelect.options).some((opt) => opt.value === severityInitial)) {
        severitySelect.value = severityInitial;
      }
      searchInput.value = searchInitial;

      const normalizeMode = (value) => {
        const raw = (value || '').trim().toLowerCase();
        if (raw === 'all') return 'all';
        if (raw === 'warning' || raw === 'passed' || raw === 'error') return raw;
        return 'error';
      };

      let chipMode = severityInitial === 'all' ? 'all' : (severityInitial || 'error');
      chipMode = normalizeMode(chipMode);

      function syncChips() {
        chips.forEach((btn) => {
          const active = (chipMode === 'all' && btn.dataset.vf === 'all') || btn.dataset.vf === chipMode;
          btn.style.outline = active ? '2px solid var(--color-border, #94a3b8)' : 'none';
          btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        });
      }

      function applyFilter() {
        const wantSev = (severitySelect.value || '').trim().toLowerCase();
        const wantSeg = (segmentSelect.value || '').trim().toLowerCase();
        const query = (searchInput.value || '').trim().toLowerCase();
        let visible = 0;
        builtRows.forEach((tr) => {
          const sev = (tr.dataset.severity || '').trim().toLowerCase();
          const seg = (tr.dataset.segment || '').trim().toLowerCase();
          const text = (tr.dataset.text || '').toLowerCase();
          let show = true;
          if (chipMode !== 'all') show = show && sev === chipMode;
          if (wantSev && wantSev !== 'all') show = show && sev === wantSev;
          if (wantSeg && wantSeg !== 'all') show = show && seg === wantSeg;
          if (query) show = show && text.includes(query);
          tr.style.display = show ? '' : 'none';
          if (show) visible += 1;
        });
        if (emptyRow) emptyRow.style.display = visible ? 'none' : '';
        syncChips();
      }

      severitySelect.addEventListener('change', () => {
        chipMode = normalizeMode(severitySelect.value);
        applyFilter();
      });
      segmentSelect.addEventListener('change', applyFilter);
      searchInput.addEventListener('input', applyFilter);
      chips.forEach((chip) => {
        chip.addEventListener('click', () => {
          chipMode = normalizeMode(chip.dataset.vf);
          severitySelect.value = chipMode === 'all' ? 'all' : chipMode;
          applyFilter();
        });
      });
      if (resetButton) {
        resetButton.addEventListener('click', () => {
          chipMode = normalizeMode('error');
          severitySelect.value = 'error';
          segmentSelect.value = 'all';
          searchInput.value = '';
          applyFilter();
        });
      }

      chipMode = normalizeMode(chipMode || 'error');
      applyFilter();
    })(document.currentScript);
  </script>

  <textarea id="validated-message" hidden>{{ _validated_message }}</textarea>
  <script>
    window.PipelineContext = window.PipelineContext || { message: '' };
    window.PipelineContext.setMessage = function(msg) {
      this.message = msg || '';
      var value = this.message;
      document.querySelectorAll('[data-bind="pipeline.message"]').forEach(function(el){
        if (!el) return;
        if ('value' in el) {
          if (el.value !== value) {
            el.value = value;
            try { el.dispatchEvent(new Event('input', { bubbles: true })); } catch (err) { /* ignore */ }
          }
        } else {
          el.textContent = value;
        }
      });
      if (window.PipelineBus && typeof window.PipelineBus.set === 'function') {
        try { window.PipelineBus.set('validate', value, { from: 'validate' }); } catch (err) { /* ignore */ }
      }
    };
    (function(){
      var field = document.getElementById('validated-message');
      if (field) {
        window.PipelineContext.setMessage(field.value || '');
      }
      if (window.InteropUI && typeof window.InteropUI.onValidateComplete === 'function') {
        try { window.InteropUI.onValidateComplete(); } catch (err) { /* ignore */ }
      }
    })();
  </script>

  <div class="action-tray visible" style="margin-top:1rem">
    <div class="action-tray-header">
      <h5 style="margin:0">Next steps</h5>
      <p class="text-small" style="margin:0.25rem 0 0 0">Continue with the validated message.</p>
    </div>
    <div class="action-cards" style="margin-top:0.75rem">
      <a class="action-card pipeline-run" href="#mllp-panel" data-run-to="mllp">
        <strong>ðŸ“¤ Send via MLLP</strong>
        <small>Deliver the validated message.</small>
      </a>
      <a class="action-card pipeline-run" href="#translate-panel" data-run-to="translate">
        <strong>ðŸ”„ HL7 â†’ FHIR</strong>
        <small>Translate this validated message.</small>
      </a>
    </div>
  </div>
</section>

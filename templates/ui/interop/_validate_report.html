<section id="validate-report" class="validate-report" data-val-report hx-swap-oob="outerHTML">
  {% set _r = r if r is defined else None %}
  {% set _issues = (_r.issues if _r is not none else (issues if issues is defined else [])) %}
  {% set _issues = _issues or [] %}
  {% set _counts = (_r.counts if _r is not none else (counts if counts is defined else {})) %}
  {% set _counts = _counts or {} %}
  {% set _summary_rows = (_r.summary_rows if _r is not none else (summary_rows if summary_rows is defined else [])) %}
  {% set _summary_rows = _summary_rows or [] %}
  {% set _seg_opts = (_r.segment_options if _r is not none else (segment_options if segment_options is defined else [])) %}
  {% set _seg_opts = _seg_opts or [] %}
  {% set _total_msgs = r.msg_total or r.total_messages or r.total or r.message_count or 1 %}
  {% set _total_msgs = _total_msgs | int %}
  {% set _raw_candidate = (_r.raw | default(None) if _r is not none else None) %}
  {% set _raw = _raw_candidate if _raw_candidate is not none else (raw if raw is defined else {}) %}
  {% set _validated_candidate = (_r.validated_message | default(None) if _r is not none else None) %}
  {% set _validated_message = _validated_candidate if _validated_candidate is not none else (validated_message if validated_message is defined else '') %}

  <header class="validate-report__header" style="display:flex;align-items:center;justify-content:space-between;gap:0.75rem">
    <h4 class="text-h3" style="margin:0">Validation report</h4>
    <div class="validate-report__counts" style="display:flex;flex-wrap:wrap;gap:0.5rem">
      <button type="button" class="chip" data-vf="passed" style="background:#10b981;color:#0b1e15">Passed: {{ _counts.ok | default(0) }}</button>
      <button type="button" class="chip" data-vf="error" style="background:#ef4444;color:#250101">Errors: {{ _counts.errors | default(0) }}</button>
      <button type="button" class="chip" data-vf="all" style="background:#475569;color:#e5e7eb">Show all</button>
    </div>
  </header>

  {% if (_counts.errors | default(0)) or (_counts.ok | default(0)) or (_counts.warnings | default(0)) %}
    <p class="text-small" style="margin-top:0.5rem">
      Found {{ _counts.errors | default(0) }} error{{ 's' if (_counts.errors | default(0)) != 1 else '' }}
      and {{ _counts.ok | default(0) }} successful validation{{ 's' if (_counts.ok | default(0)) != 1 else '' }}.
    </p>
  {% endif %}

  <div class="card mt" style="padding:.5rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">
    <label class="small">Severity
      <select class="input" data-role="val-filter-sev" style="min-width:8rem">
        <option value="all">All</option>
        <option value="passed">Passed</option>
        <option value="error" selected>Error</option>
        <option value="warning">Warning</option>
      </select>
    </label>
    <label class="small">Segment
      <select class="input" data-role="val-filter-seg" style="min-width:8rem">
        <option value="all">All</option>
        {% for seg in _seg_opts %}
          <option value="{{ seg | e }}">{{ seg }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="small" style="flex:1 1 240px">Search
      <input class="input" data-role="val-filter-text" placeholder="Filter by rule, message, or value…" />
    </label>
    <button type="button" class="btn btn-xs" data-role="val-filter-reset" style="margin-left:auto">Reset filters</button>
    <span class="muted small">Across {{ _total_msgs }} message{{ '' if _total_msgs == 1 else 's' }}. Unique rows are de-duplicated by rule.</span>
  </div>

  <div class="scrollbox" style="margin-top:0.75rem">
    <table class="validate-report__table" style="width:100%;border-collapse:collapse;font-size:0.875rem">
      <thead>
        <tr style="text-align:left;border-bottom:1px solid var(--color-border, #d1d5db)">
          <th style="padding:0.5rem">Severity</th>
          <th style="padding:0.5rem">Rule / Code</th>
          <th style="padding:0.5rem">Segment</th>
          <th style="padding:0.5rem">Field</th>
          <th style="padding:0.5rem">Comp</th>
          <th style="padding:0.5rem">Subcomp</th>
          <th style="padding:0.5rem">Value</th>
          <th style="padding:0.5rem">Message</th>
          <th style="padding:0.5rem">Count</th>
          <th style="padding:0.5rem">Total</th>
          <th style="padding:0.5rem">%</th>
        </tr>
      </thead>
      <tbody data-role="val-summary-body"></tbody>
    </table>
  </div>

  <details class="mt" style="margin-top:0.75rem">
    <summary class="text-small">Show raw JSON</summary>
    <pre class="codepane mono" style="margin-top:0.5rem">{{ _raw | tojson(indent=2) }}</pre>
  </details>
  <script type="application/json" data-role="val-issues" data-total="{{ _total_msgs }}">{{ _issues | tojson }}</script>
  <script>
    (function(script){
      const root = script.closest('#validate-report');
      if (!root) return;
      const dataEl = root.querySelector('[data-role="val-issues"]');
      if (!dataEl) return;
      let issues = [];
      try {
        issues = JSON.parse(dataEl.textContent || '[]') || [];
      } catch (err) {
        issues = [];
      }
      const TOTAL = parseInt(dataEl.dataset.total || '1', 10) || 1;

      const severitySelect = root.querySelector('[data-role="val-filter-sev"]');
      const segmentSelect = root.querySelector('[data-role="val-filter-seg"]');
      const searchInput = root.querySelector('[data-role="val-filter-text"]');
      const resetButton = root.querySelector('[data-role="val-filter-reset"]');
      const body = root.querySelector('[data-role="val-summary-body"]');
      if (!severitySelect || !segmentSelect || !searchInput || !body) return;

      const chips = Array.from(root.querySelectorAll('.chip[data-vf]'));
      const segments = new Set();
      const aggregate = new Map();

      const normalize = (item) => {
        if (!item || typeof item !== 'object') return {};
        const severity = String(item.severity || item.status || 'error').toLowerCase();
        let normalizedSeverity = 'error';
        if (severity.includes('warn')) {
          normalizedSeverity = 'warning';
        } else if (severity.includes('ok') || severity.includes('pass') || severity.includes('info')) {
          normalizedSeverity = 'passed';
        }
        const code = String(item.code || item.rule || item.id || '').trim();
        const segment = String(item.segment || '').trim();
        const field = item.field === 0 ? '0' : String(item.field ?? '').trim();
        const component = item.component === 0 ? '0' : String(item.component ?? '').trim();
        const subcomponent = item.subcomponent === 0 ? '0' : String(item.subcomponent ?? '').trim();
        const message = String(item.message || '').trim();
        const value = String(item.value || item.actual || item.expected || '').trim();
        if (segment) segments.add(segment);
        return {
          severity: normalizedSeverity,
          code,
          segment,
          field,
          component,
          subcomponent,
          message,
          value,
        };
      };

      issues.forEach((raw) => {
        const row = normalize(raw);
        const key = [
          row.severity,
          row.code,
          row.segment,
          row.field,
          row.component,
          row.subcomponent,
          row.message,
        ].join('|');
        if (!aggregate.has(key)) {
          aggregate.set(key, {
            severity: row.severity,
            code: row.code,
            segment: row.segment,
            field: row.field,
            component: row.component,
            subcomponent: row.subcomponent,
            message: row.message,
            values: new Set(),
            count: 0,
          });
        }
        const slot = aggregate.get(key);
        if (row.value) slot.values.add(row.value);
        slot.count += 1;
      });

      const bySeverity = (severity) => {
        if (severity === 'error') return 0;
        if (severity === 'warning') return 1;
        if (severity === 'passed') return 2;
        return 3;
      };

      const rows = Array.from(aggregate.values()).sort((a, b) => {
        return bySeverity(a.severity) - bySeverity(b.severity)
          || (a.segment || '').localeCompare(b.segment || '')
          || (parseInt(a.field || '0', 10) - parseInt(b.field || '0', 10))
          || (a.code || '').localeCompare(b.code || '');
      }).map((row) => {
        const values = Array.from(row.values);
        const shown = values.slice(0, 8);
        const extra = values.length > 8 ? ` (+${values.length - 8} more)` : '';
        return {
          severity: row.severity,
          severityLabel: row.severity === 'passed' ? 'Passed' : (row.severity === 'warning' ? 'Warning' : 'Error'),
          code: row.code || '—',
          segment: row.segment || '—',
          field: row.field || '—',
          component: row.component || '—',
          subcomponent: row.subcomponent || '—',
          message: row.message || '—',
          valuesText: shown.length ? shown.join(', ') : '—',
          valuesExtra: extra,
          count: row.count,
          percent: TOTAL ? Math.round((row.count / TOTAL) * 100) : 0,
          total: TOTAL,
          searchText: [row.code, row.segment, row.field, row.component, row.subcomponent, values.join(' '), row.message]
            .join(' ')
            .toLowerCase(),
        };
      });

      const segmentOptions = Array.from(segments).sort();
      segmentOptions.forEach((segment) => {
        const opt = document.createElement('option');
        opt.value = segment;
        opt.textContent = segment;
        segmentSelect.appendChild(opt);
      });

      let chipMode = 'error';

      function syncChips() {
        chips.forEach((btn) => {
          const active = (chipMode === 'all' && btn.dataset.vf === 'all') || btn.dataset.vf === chipMode;
          btn.style.outline = active ? '2px solid var(--color-border, #94a3b8)' : 'none';
          btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        });
      }

      function render() {
        const wantSev = severitySelect.value;
        const wantSeg = segmentSelect.value;
        const query = (searchInput.value || '').trim().toLowerCase();
        body.innerHTML = '';
        let visible = 0;
        rows.forEach((row) => {
          if (chipMode !== 'all' && row.severity !== chipMode) return;
          if (wantSev !== 'all' && row.severity !== wantSev) return;
          if (wantSeg !== 'all' && row.segment !== wantSeg) return;
          if (query && !row.searchText.includes(query)) return;
          const tr = document.createElement('tr');
          tr.setAttribute('data-severity', row.severity);
          tr.setAttribute('data-segment', row.segment);
          tr.innerHTML = `
            <td style="padding:0.5rem">${row.severityLabel}</td>
            <td style="padding:0.5rem"><code class="mono">${row.code}</code></td>
            <td style="padding:0.5rem"><code class="mono">${row.segment}</code></td>
            <td style="padding:0.5rem"><code class="mono">${row.field}</code></td>
            <td style="padding:0.5rem"><code class="mono">${row.component}</code></td>
            <td style="padding:0.5rem"><code class="mono">${row.subcomponent}</code></td>
            <td style="padding:0.5rem">${row.valuesText}${row.valuesExtra}</td>
            <td style="padding:0.5rem">${row.message}</td>
            <td style="padding:0.5rem">${row.count}</td>
            <td style="padding:0.5rem">${row.count}/${row.total}</td>
            <td style="padding:0.5rem">${row.percent}%</td>
          `;
          body.appendChild(tr);
          visible += 1;
        });
        if (!visible) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="11" class="muted" style="padding:.75rem">No issues to display.</td>';
          body.appendChild(tr);
        }
      }

      severitySelect.addEventListener('change', () => {
        chipMode = severitySelect.value === 'all' ? 'all' : severitySelect.value;
        syncChips();
        render();
      });
      segmentSelect.addEventListener('change', render);
      searchInput.addEventListener('input', render);
      chips.forEach((chip) => {
        chip.addEventListener('click', () => {
          chipMode = chip.dataset.vf === 'all' ? 'all' : chip.dataset.vf;
          severitySelect.value = chipMode;
          syncChips();
          render();
        });
      });
      if (resetButton) {
        resetButton.addEventListener('click', () => {
          chipMode = 'error';
          severitySelect.value = 'error';
          segmentSelect.value = 'all';
          searchInput.value = '';
          syncChips();
          render();
        });
      }

      severitySelect.value = 'error';
      chipMode = 'error';
      syncChips();
      render();
    })(document.currentScript);
  </script>

  <textarea id="validated-message" hidden>{{ _validated_message }}</textarea>
  <script>
    window.PipelineContext = window.PipelineContext || { message: '' };
    window.PipelineContext.setMessage = function(msg) {
      this.message = msg || '';
      var value = this.message;
      document.querySelectorAll('[data-bind="pipeline.message"]').forEach(function(el){
        if (!el) return;
        if ('value' in el) {
          if (el.value !== value) {
            el.value = value;
            try { el.dispatchEvent(new Event('input', { bubbles: true })); } catch (err) { /* ignore */ }
          }
        } else {
          el.textContent = value;
        }
      });
      if (window.PipelineBus && typeof window.PipelineBus.set === 'function') {
        try { window.PipelineBus.set('validate', value, { from: 'validate' }); } catch (err) { /* ignore */ }
      }
    };
    (function(){
      var field = document.getElementById('validated-message');
      if (field) {
        window.PipelineContext.setMessage(field.value || '');
      }
      if (window.InteropUI && typeof window.InteropUI.onValidateComplete === 'function') {
        try { window.InteropUI.onValidateComplete(); } catch (err) { /* ignore */ }
      }
    })();
  </script>

  <div class="action-tray visible" style="margin-top:1rem">
    <div class="action-tray-header">
      <h5 style="margin:0">Next steps</h5>
      <p class="text-small" style="margin:0.25rem 0 0 0">Continue with the validated message.</p>
    </div>
    <div class="action-cards" style="margin-top:0.75rem">
      <a class="action-card pipeline-run" href="#mllp-panel" data-run-to="mllp">
        <strong>📤 Send via MLLP</strong>
        <small>Deliver the validated message.</small>
      </a>
      <a class="action-card pipeline-run" href="#translate-panel" data-run-to="translate">
        <strong>🔄 HL7 → FHIR</strong>
        <small>Translate this validated message.</small>
      </a>
    </div>
  </div>
</section>

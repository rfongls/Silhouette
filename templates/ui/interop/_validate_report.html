<section class="validate-report" data-val-report>
  <header class="validate-report__header" style="display:flex;align-items:center;justify-content:space-between;gap:0.75rem">
    <h4 class="text-h3" style="margin:0">Validation report</h4>
    <div class="validate-report__counts" style="display:flex;flex-wrap:wrap;gap:0.5rem">
      <span class="chip" style="background:#10b981;color:#0b1e15">Passed: {{ r.counts.ok | default(0) }}</span>
      <span class="chip" style="background:#ef4444;color:#250101">Errors: {{ r.counts.errors | default(0) }}</span>
      <span class="chip" style="background:#475569;color:#e5e7eb">Show all</span>
    </div>
  </header>

  {% if r.counts.errors | default(0) or r.counts.ok | default(0) or r.counts.warnings | default(0) %}
    <p class="text-small" style="margin-top:0.5rem">
      Found {{ r.counts.errors | default(0) }} error{{ 's' if (r.counts.errors | default(0)) != 1 else '' }}
      and {{ r.counts.ok | default(0) }} successful validation{{ 's' if (r.counts.ok | default(0)) != 1 else '' }}.
    </p>
  {% endif %}

  {% set _total_msgs = r.msg_total or r.total_messages or r.total or r.message_count or 1 %}

  {# Build aggregated rows server-side so HTMX swaps render correctly #}
  {% set ns = namespace(groups={}) %}
  {% for it in r.issues %}
    {% set sev = (it.severity | default('error')) | lower %}
    {% set sev = 'passed' if sev == 'ok' else sev %}
    {% set code = it.code or it.rule or '' %}
    {% set seg = it.segment or '' %}
    {% set fld = (it.field is not none and it.field) or '' %}
    {% set cmp = (it.component is not none and it.component) or '' %}
    {% set sub = (it.subcomponent is not none and it.subcomponent) or '' %}
    {% set ord = 0 if sev == 'error' else (1 if sev == 'warning' else 2) %}
    {% set key = (ord|string) ~ '|' ~ sev ~ '|' ~ code ~ '|' ~ seg ~ '|' ~ fld ~ '|' ~ cmp ~ '|' ~ sub %}
    {% set group = ns.groups.get(key) %}
    {% if not group %}
      {% set group = {
        'severity': sev,
        'code': code,
        'segment': seg,
        'field': fld,
        'component': cmp,
        'subcomponent': sub,
        'values': [],
        'message': it.message or '',
        'count': 0
      } %}
    {% endif %}
    {% if it.value is not none %}
      {% set val = (it.value|string) %}
      {% if val not in group.values %}{% set _ = group.values.append(val) %}{% endif %}
    {% endif %}
    {% set _ = group.update({'count': group.count + 1, 'message': group.message or (it.message or '')}) %}
    {% set _ = ns.groups.update({key: group}) %}
  {% endfor %}

  <div class="scrollbox" style="margin-top:0.75rem">
    <table class="validate-report__table" id="val-summary-table" style="width:100%;border-collapse:collapse;font-size:0.875rem">
      <thead>
        <tr style="text-align:left;border-bottom:1px solid var(--color-border, #d1d5db)">
          <th style="padding:0.5rem">Severity</th>
          <th style="padding:0.5rem">Rule / Code</th>
          <th style="padding:0.5rem">Segment</th>
          <th style="padding:0.5rem">Field</th>
          <th style="padding:0.5rem">Comp</th>
          <th style="padding:0.5rem">Subcomp</th>
          <th style="padding:0.5rem">Value</th>
          <th style="padding:0.5rem">Message</th>
          <th style="padding:0.5rem">Count</th>
          <th style="padding:0.5rem">Total</th>
          <th style="padding:0.5rem">%</th>
        </tr>
      </thead>
      <tbody>
        {% for key, group in ns.groups | dictsort %}
          {% set pct = ((100 * group.count) / _total_msgs) | round(0, 'common') | int %}
          <tr class="row-{{ group.severity }}" style="border-bottom:1px solid var(--color-border, #e5e7eb)">
            <td style="padding:0.5rem">{{ 'Passed' if group.severity == 'passed' else (group.severity | capitalize) }}</td>
            <td style="padding:0.5rem"><code class="mono">{{ group.code or 'â€”' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ group.segment or 'â€”' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ group.field or 'â€”' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ group.component or 'â€”' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ group.subcomponent or 'â€”' }}</code></td>
            <td style="padding:0.5rem">{{ group.values | join(', ') if group.values else 'â€”' }}</td>
            <td style="padding:0.5rem">{{ group.message or 'â€”' }}</td>
            <td style="padding:0.5rem">{{ group.count }}</td>
            <td style="padding:0.5rem">{{ group.count }}/{{ _total_msgs }}</td>
            <td style="padding:0.5rem">{{ pct }}%</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="11" class="muted" style="padding:0.75rem">No issues to display.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <details class="mt" style="margin-top:0.75rem">
    <summary class="text-small">Show raw JSON</summary>
    <pre class="codepane mono" style="margin-top:0.5rem">{{ r.raw | tojson(indent=2) }}</pre>
  </details>

  <script type="application/json" id="val-issues-json" data-total="{{ _total_msgs }}">{{ r.issues | tojson }}</script>

  <script>
    (function(){
      const dataEl = document.getElementById('val-issues-json');
      let issues = [];
      try { issues = JSON.parse(dataEl.textContent || '[]') || []; } catch (err) { issues = []; }
      const TOTAL = parseInt(dataEl.dataset.total || '1', 10) || 1;

      const norm = (item) => ({
        severity: (item.severity || '').toString().toLowerCase(),
        code: (item.code || item.rule || '').toString(),
        segment: (item.segment || '').toString(),
        field: (item.field ?? '').toString(),
        component: (item.component ?? '').toString(),
        subcomponent: (item.subcomponent ?? '').toString(),
        value: (item.value ?? '').toString(),
        message: (item.message ?? '').toString()
      });

      const rows = new Map();
      const segments = new Set();

      for (const raw of issues) {
        const item = norm(raw);
        const severity = item.severity === 'ok' ? 'passed' : (item.severity || 'error');
        const key = [severity, item.code, item.segment, item.field, item.component, item.subcomponent].join('|');
        let row = rows.get(key);
        if (!row) {
          row = {
            severity,
            code: item.code,
            segment: item.segment,
            field: item.field,
            component: item.component,
            subcomponent: item.subcomponent,
            values: new Set(),
            message: item.message,
            count: 0
          };
          rows.set(key, row);
        }
        if (item.segment) segments.add(item.segment);
        if (item.value) row.values.add(item.value);
        row.count += 1;
        if (!row.message && item.message) {
          row.message = item.message;
        }
      }

      const body = document.getElementById('val-summary-body');
      body.innerHTML = '';

      const toPct = (n) => {
        if (!TOTAL) return '0%';
        return Math.round((n / TOTAL) * 100) + '%';
      };

      const cap = 8;
      const list = Array.from(rows.values()).sort((a, b) => {
        const order = (x) => x.severity === 'error' ? 0 : (x.severity === 'warning' ? 1 : 2);
        return order(a) - order(b)
          || (a.segment || '').localeCompare(b.segment || '')
          || (parseInt(a.field || '0', 10) - parseInt(b.field || '0', 10))
          || (a.code || '').localeCompare(b.code || '');
      });

      for (const row of list) {
        const values = Array.from(row.values);
        const shown = values.slice(0, cap).join(', ');
        const more = values.length > cap ? `  (+${values.length - cap} more)` : '';
        const severityLabel = row.severity === 'passed' ? 'Passed' : (row.severity === 'warning' ? 'Warning' : 'Error');

        const tr = document.createElement('tr');
        tr.className = row.severity;
        tr.setAttribute('data-severity', row.severity);
        tr.setAttribute('data-segment', row.segment || '');
        tr.setAttribute('data-text', [row.code, row.segment, row.field, row.component, row.subcomponent, shown, row.message].join(' ').toLowerCase());
        tr.innerHTML = `
          <td style="padding:0.5rem">${severityLabel}</td>
          <td style="padding:0.5rem"><code class="mono">${row.code || 'â€”'}</code></td>
          <td style="padding:0.5rem"><code class="mono">${row.segment || 'â€”'}</code></td>
          <td style="padding:0.5rem"><code class="mono">${row.field || 'â€”'}</code></td>
          <td style="padding:0.5rem"><code class="mono">${row.component || 'â€”'}</code></td>
          <td style="padding:0.5rem"><code class="mono">${row.subcomponent || 'â€”'}</code></td>
          <td style="padding:0.5rem">${shown || 'â€”'}${more}</td>
          <td style="padding:0.5rem">${row.message || 'â€”'}</td>
          <td style="padding:0.5rem">${row.count}</td>
          <td style="padding:0.5rem">${row.count}/${TOTAL}</td>
          <td style="padding:0.5rem">${toPct(row.count)}</td>
        `;
        body.appendChild(tr);
      }

      const segSelect = document.getElementById('val-filter-seg');
      Array.from(segments).sort().forEach((segment) => {
        const option = document.createElement('option');
        option.value = segment;
        option.textContent = segment;
        segSelect.appendChild(option);
      });

      const chip = (name) => document.querySelector(`.chip[data-vf="${name}"]`);
      const selSev = document.getElementById('val-filter-sev');
      const selSeg = document.getElementById('val-filter-seg');
      const txt = document.getElementById('val-filter-text');
      let chipMode = 'all';

      function applyFilter() {
        const wantSev = selSev.value;
        const wantSeg = selSeg.value;
        const query = (txt.value || '').trim().toLowerCase();
        for (const tr of body.querySelectorAll('tr')) {
          const sev = tr.getAttribute('data-severity');
          const seg = tr.getAttribute('data-segment');
          const text = tr.getAttribute('data-text') || '';
          let show = true;
          if (chipMode !== 'all') show = show && (sev === chipMode);
          if (wantSev !== 'all') show = show && (sev === wantSev);
          if (wantSeg !== 'all') show = show && (seg === wantSeg);
          if (query) show = show && text.includes(query);
          tr.style.display = show ? '' : 'none';
        }
      }

      [selSev, selSeg, txt].forEach((el) => el.addEventListener('input', applyFilter));
      chip('passed').addEventListener('click', () => { chipMode = 'passed'; applyFilter(); });
      chip('errors').addEventListener('click', () => { chipMode = 'error'; applyFilter(); });
      chip('all').addEventListener('click', () => { chipMode = 'all'; applyFilter(); });

      applyFilter();
    })();
  </script>

  <textarea id="validated-message" hidden>{{ r.validated_message }}</textarea>
  <script>
    window.PipelineContext = window.PipelineContext || { message: '' };
    window.PipelineContext.setMessage = function(msg) {
      this.message = msg || '';
      var value = this.message;
      document.querySelectorAll('[data-bind="pipeline.message"]').forEach(function(el){
        if (!el) return;
        if ('value' in el) {
          if (el.value !== value) {
            el.value = value;
            try { el.dispatchEvent(new Event('input', { bubbles: true })); } catch (err) { /* ignore */ }
          }
        } else {
          el.textContent = value;
        }
      });
      if (window.PipelineBus && typeof window.PipelineBus.set === 'function') {
        try { window.PipelineBus.set('validate', value, { from: 'validate' }); } catch (err) { /* ignore */ }
      }
    };
    (function(){
      var field = document.getElementById('validated-message');
      if (field) {
        window.PipelineContext.setMessage(field.value || '');
      }
      if (window.InteropUI && typeof window.InteropUI.onValidateComplete === 'function') {
        try { window.InteropUI.onValidateComplete(); } catch (err) { /* ignore */ }
      }
    })();
  </script>

  <div class="action-tray visible" style="margin-top:1rem">
    <div class="action-tray-header">
      <h5 style="margin:0">Next steps</h5>
      <p class="text-small" style="margin:0.25rem 0 0 0">Continue with the validated message.</p>
    </div>
    <div class="action-cards" style="margin-top:0.75rem">
      <a class="action-card pipeline-run" href="#mllp-panel" data-run-to="mllp">
        <strong>ðŸ“¤ Send via MLLP</strong>
        <small>Deliver the validated message.</small>
      </a>
      <a class="action-card pipeline-run" href="#translate-panel" data-run-to="translate">
        <strong>ðŸ”„ HL7 â†’ FHIR</strong>
        <small>Translate this validated message.</small>
      </a>
    </div>
  </div>
</section>

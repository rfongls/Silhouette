<section class="validate-report" data-val-report>
  <header class="validate-report__header" style="display:flex;align-items:center;justify-content:space-between;gap:0.75rem">
    <h4 class="text-h3" style="margin:0">Validation report</h4>
    {% set current = r.show or 'errors' %}
    <nav class="validate-report__counts" style="display:flex;flex-wrap:wrap;gap:0.5rem">
      <button type="button"
              class="chip"
              hx-post="{{ validate_api }}?format=html&amp;show=ok"
              hx-include="#validate-form"
              hx-target="#validate-report"
              hx-swap="innerHTML"
              aria-pressed="{{ 'true' if current == 'ok' else 'false' }}"
              style="background:#10b981;color:#0b1e15;{% if current == 'ok' %}box-shadow:0 0 0 2px rgba(0,0,0,0.25) inset;{% endif %}">
        OK: {{ r.counts.ok | default(0) }}
      </button>
      <button type="button"
              class="chip"
              hx-post="{{ validate_api }}?format=html&amp;show=warnings"
              hx-include="#validate-form"
              hx-target="#validate-report"
              hx-swap="innerHTML"
              aria-pressed="{{ 'true' if current == 'warnings' else 'false' }}"
              style="background:#f59e0b;color:#1f1300;{% if current == 'warnings' %}box-shadow:0 0 0 2px rgba(0,0,0,0.25) inset;{% endif %}">
        Warnings: {{ r.counts.warnings | default(0) }}
      </button>
      <button type="button"
              class="chip"
              hx-post="{{ validate_api }}?format=html&amp;show=errors"
              hx-include="#validate-form"
              hx-target="#validate-report"
              hx-swap="innerHTML"
              aria-pressed="{{ 'true' if current == 'errors' else 'false' }}"
              style="background:#ef4444;color:#250101;{% if current == 'errors' %}box-shadow:0 0 0 2px rgba(0,0,0,0.25) inset;{% endif %}">
        Errors: {{ r.counts.errors | default(0) }}
      </button>
      <button type="button"
              class="chip"
              hx-post="{{ validate_api }}?format=html&amp;show=all"
              hx-include="#validate-form"
              hx-target="#validate-report"
              hx-swap="innerHTML"
              aria-pressed="{{ 'true' if current == 'all' else 'false' }}"
              style="background:#64748b;color:#0b1220;{% if current == 'all' %}box-shadow:0 0 0 2px rgba(255,255,255,0.35) inset;{% endif %}">
        Show all
      </button>
    </nav>
  </header>

  {% if r.counts.errors | default(0) %}
    <p class="text-small" style="margin-top:0.5rem">Found {{ r.counts.errors | default(0) }} error{{ 's' if (r.counts.errors | default(0)) != 1 else '' }} and {{ r.counts.warnings | default(0) }} warning{{ 's' if (r.counts.warnings | default(0)) != 1 else '' }}.</p>
  {% else %}
    <p class="text-small" style="margin-top:0.5rem;color:#0f5132">No blocking errors detected. You can proceed to MLLP send.</p>
  {% endif %}

  <div class="scrollbox" style="margin-top:0.75rem">
    <table class="validate-report__table" data-val-table style="width:100%;border-collapse:collapse;font-size:0.875rem">
      <thead>
        <tr style="text-align:left;border-bottom:1px solid var(--color-border, #d1d5db)">
          <th style="padding:0.5rem">Severity</th>
          <th style="padding:0.5rem">Rule / Code</th>
          <th style="padding:0.5rem">Segment</th>
          <th style="padding:0.5rem">Field</th>
          <th style="padding:0.5rem">Comp</th>
          <th style="padding:0.5rem">Subcomp</th>
          <th style="padding:0.5rem">Value</th>
          <th style="padding:0.5rem">Message</th>
        </tr>
      </thead>
      <tbody>
      {% for it in r.rows %}
        {% set severity = (it.severity | default('error')) | lower %}
        <tr data-severity="{{ severity }}" style="border-bottom:1px solid var(--color-border, #e5e7eb)">
          <td style="padding:0.5rem">{{ severity | capitalize }}</td>
          <td style="padding:0.5rem"><code class="mono">{{ it.code or 'â€”' }}</code></td>
          <td style="padding:0.5rem"><code class="mono">{{ it.segment or 'â€”' }}</code></td>
          <td style="padding:0.5rem"><code class="mono">{{ it.field if it.field is not none else 'â€”' }}</code></td>
          <td style="padding:0.5rem"><code class="mono">{{ it.component if it.component is not none else 'â€”' }}</code></td>
          <td style="padding:0.5rem"><code class="mono">{{ it.subcomponent if it.subcomponent is not none else 'â€”' }}</code></td>
          <td style="padding:0.5rem"><code class="mono">{{ it.value or 'â€”' }}</code></td>
          <td style="padding:0.5rem">{{ it.message or (severity == 'ok' and 'Passed') or 'â€”' }}</td>
        </tr>
      {% else %}
        <tr>
          <td colspan="8" style="padding:0.75rem" class="muted">No rows to display.</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <details class="mt" style="margin-top:0.75rem">
    <summary class="text-small">Show raw JSON</summary>
    <pre class="codepane mono" style="margin-top:0.5rem">{{ r.raw | tojson(indent=2) }}</pre>
  </details>

  <textarea id="validated-message" hidden>{{ r.validated_message }}</textarea>
  <script>
    window.PipelineContext = window.PipelineContext || { message: '' };
    window.PipelineContext.setMessage = function(msg) {
      this.message = msg || '';
      var value = this.message;
      document.querySelectorAll('[data-bind="pipeline.message"]').forEach(function(el){
        if (!el) return;
        if ('value' in el) {
          if (el.value !== value) {
            el.value = value;
            try { el.dispatchEvent(new Event('input', { bubbles: true })); } catch (err) { /* ignore */ }
          }
        } else {
          el.textContent = value;
        }
      });
      if (window.PipelineBus && typeof window.PipelineBus.set === 'function') {
        try { window.PipelineBus.set('validate', value, { from: 'validate' }); } catch (err) { /* ignore */ }
      }
    };
    (function(){
      var field = document.getElementById('validated-message');
      if (field) {
        window.PipelineContext.setMessage(field.value || '');
      }
      if (window.InteropUI && typeof window.InteropUI.onValidateComplete === 'function') {
        try { window.InteropUI.onValidateComplete(); } catch (err) { /* ignore */ }
      }
    })();
  </script>

  <div class="action-tray visible" style="margin-top:1rem">
    <div class="action-tray-header">
      <h5 style="margin:0">Next steps</h5>
      <p class="text-small" style="margin:0.25rem 0 0 0">Continue with the validated message.</p>
    </div>
    <div class="action-cards" style="margin-top:0.75rem">
      <a class="action-card pipeline-run" href="#mllp-panel" data-run-to="mllp">
        <strong>ðŸ“¤ Send via MLLP</strong>
        <small>Deliver the validated message.</small>
      </a>
      <a class="action-card pipeline-run" href="#translate-panel" data-run-to="translate">
        <strong>ðŸ”„ HL7 â†’ FHIR</strong>
        <small>Translate this validated message.</small>
      </a>
    </div>
  </div>
</section>

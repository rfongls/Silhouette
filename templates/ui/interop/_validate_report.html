<section id="validate-report" class="validate-report" data-val-root hx-swap-oob="outerHTML">
  {% set _r = r if r is defined else None %}
  {% set _issues = (_r.issues if _r is not none else (issues if issues is defined else [])) %}
  {% set _issues = _issues or [] %}
  {% set _counts = (_r.counts if _r is not none else (counts if counts is defined else {})) %}
  {% set _counts = _counts or {} %}
  {% set _summary_rows = (_r.summary_rows if _r is not none else (summary_rows if summary_rows is defined else [])) %}
  {% set _summary_rows = _summary_rows or [] %}
  {% set _seg_opts = (_r.segment_options if _r is not none else (segment_options if segment_options is defined else [])) %}
  {% set _seg_opts = _seg_opts or [] %}
  {% set _total_msgs = r.msg_total or r.total_messages or r.total or r.message_count or 1 %}
  {% set _total_msgs = _total_msgs | int %}
  {% set _raw_candidate = (_r.raw | default(None) if _r is not none else None) %}
  {% set _raw = _raw_candidate if _raw_candidate is not none else (raw if raw is defined else {}) %}
  {% set _validated_candidate = (_r.validated_message | default(None) if _r is not none else None) %}
  {% set _validated_message = _validated_candidate if _validated_candidate is not none else (validated_message if validated_message is defined else '') %}

  <header class="validate-report__header" style="display:flex;align-items:center;justify-content:space-between;gap:0.75rem">
    <h4 class="text-h3" style="margin:0">Validation report</h4>
    <div class="validate-report__counts" style="display:flex;flex-wrap:wrap;gap:0.5rem">
      <button type="button" class="chip" data-vf="passed" style="background:#10b981;color:#0b1e15">Passed: {{ _counts.ok | default(0) }}</button>
      <button type="button" class="chip" data-vf="errors" style="background:#ef4444;color:#250101">Errors: {{ _counts.errors | default(0) }}</button>
      <button type="button" class="chip" data-vf="all" style="background:#475569;color:#e5e7eb">Show all</button>
    </div>
  </header>

  {% if (_counts.errors | default(0)) or (_counts.ok | default(0)) or (_counts.warnings | default(0)) %}
    <p class="text-small" style="margin-top:0.5rem">
      Found {{ _counts.errors | default(0) }} error{{ 's' if (_counts.errors | default(0)) != 1 else '' }}
      and {{ _counts.ok | default(0) }} successful validation{{ 's' if (_counts.ok | default(0)) != 1 else '' }}.
    </p>
  {% endif %}

  <div class="card mt" style="padding:.5rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">
    <label class="small">Severity
      <select class="input" data-val-sev style="min-width:8rem">
        <option value="all">All</option>
        <option value="passed">Passed</option>
        <option value="error" selected>Error</option>
        <option value="warning">Warning</option>
      </select>
    </label>
    <label class="small">Segment
      <select class="input" data-val-seg style="min-width:8rem">
        <option value="all">All</option>
        {% for seg in _seg_opts %}
          <option value="{{ seg | e }}">{{ seg }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="small" style="flex:1 1 240px">Search
      <input class="input" data-val-q placeholder="Filter by rule, message, or value…" />
    </label>
    <button type="button" class="btn btn-xs" data-val-reset style="margin-left:auto">Reset filters</button>
    <span class="muted small">Across {{ _total_msgs }} message{{ '' if _total_msgs == 1 else 's' }}. Unique rows are de-duplicated by rule.</span>
  </div>

  <div class="scrollbox" style="margin-top:0.75rem">
    <table class="validate-report__table" style="width:100%;border-collapse:collapse;font-size:0.875rem">
      <thead>
        <tr style="text-align:left;border-bottom:1px solid var(--color-border, #d1d5db)">
          <th style="padding:0.5rem">Severity</th>
          <th style="padding:0.5rem">Rule / Code</th>
          <th style="padding:0.5rem">Segment</th>
          <th style="padding:0.5rem">Field</th>
          <th style="padding:0.5rem">Comp</th>
          <th style="padding:0.5rem">Subcomp</th>
          <th style="padding:0.5rem">Value</th>
          <th style="padding:0.5rem">Message</th>
          <th style="padding:0.5rem">Count</th>
          <th style="padding:0.5rem">Total</th>
          <th style="padding:0.5rem">%</th>
        </tr>
      </thead>
      <tbody data-val-body>
        {% for row in _summary_rows %}
          {% set _sev = (row.severity or 'error') %}
          {% set _seg = row.segment or '' %}
          {% set _field = row.field if row.field is not none else '' %}
          {% set _comp = row.component if row.component is not none else '' %}
          {% set _sub = row.subcomponent if row.subcomponent is not none else '' %}
          {% set _values = row.shown_values or '' %}
          {% set _extra = row.extra_values | int %}
          {% set _message = row.message or '' %}
          {% set _severity_label = 'Error' %}
          {% if _sev == 'warning' %}
            {% set _severity_label = 'Warning' %}
          {% elif _sev == 'passed' %}
            {% set _severity_label = 'Passed' %}
          {% endif %}
          <tr
            class="{{ _sev }}"
            data-severity="{{ _sev | e }}"
            data-segment="{{ _seg | e }}"
            data-text="{{ (row.search_text or '') | e }}"
          >
            <td style="padding:0.5rem">{{ _severity_label }}</td>
            <td style="padding:0.5rem"><code class="mono">{{ row.code or '—' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ _seg or '—' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ row.field if row.field is not none else '—' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ row.component if row.component is not none else '—' }}</code></td>
            <td style="padding:0.5rem"><code class="mono">{{ row.subcomponent if row.subcomponent is not none else '—' }}</code></td>
            <td style="padding:0.5rem">
              {% if _values %}{{ _values }}{% else %}—{% endif %}
              {% if _extra > 0 %} (+{{ _extra }} more){% endif %}
            </td>
            <td style="padding:0.5rem">{{ _message or '—' }}</td>
            <td style="padding:0.5rem">{{ row.count }}</td>
            <td style="padding:0.5rem">{{ row.count }}/{{ row.total }}</td>
            <td style="padding:0.5rem">{{ row.pct }}%</td>
          </tr>
        {% endfor %}
        {% if _summary_rows|length == 0 %}
          <tr>
            <td colspan="11" class="muted" style="padding:.75rem">No issues to display.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <details class="mt" style="margin-top:0.75rem">
    <summary class="text-small">Show raw JSON</summary>
    <pre class="codepane mono" style="margin-top:0.5rem">{{ _raw | tojson(indent=2) }}</pre>
  </details>

  <script>
    (function(){
      const root   = document.currentScript.closest('[data-val-root]');
      const body = root.querySelector('[data-val-body]');
      const rows = Array.from(body.querySelectorAll('tr')).filter((tr) => tr.hasAttribute('data-severity'));
      const chip = (name) => root.querySelector(`.chip[data-vf="${name}"]`);
      const selSev = root.querySelector('[data-val-sev]');
      const selSeg = root.querySelector('[data-val-seg]');
      const txt    = root.querySelector('[data-val-q]');
      const reset  = root.querySelector('[data-val-reset]');

      if (!selSev || !selSeg || !txt) {
        return;
      }

      function updateChipStyles() {
        const current = selSev.value;
        for (const btn of root.querySelectorAll('.validate-report__counts .chip')) {
          const active = btn.dataset.vf === current;
          btn.style.outline = active ? '2px solid var(--color-border, #94a3b8)' : 'none';
          btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        }
      }

      function applyFilter() {
        const wantSev = selSev.value;
        const wantSeg = selSeg.value;
        const query = (txt.value || '').trim().toLowerCase();
        for (const tr of rows) {
          const sev = tr.getAttribute('data-severity');
          const seg = tr.getAttribute('data-segment');
          const text = tr.getAttribute('data-text') || '';
          let show = true;
          if (wantSev !== 'all') show = show && (sev === wantSev);
          if (wantSeg !== 'all') show = show && (seg === wantSeg);
          if (query) show = show && text.includes(query);
          tr.style.display = show ? '' : 'none';
        }
        updateChipStyles();
      }

      if (selSev) selSev.addEventListener('change', () => {
        applyFilter();
      });
      if (selSeg) selSeg.addEventListener('change', applyFilter);
      if (txt) txt.addEventListener('input', applyFilter);

      const passedChip = chip('passed');
      if (passedChip) {
        passedChip.addEventListener('click', () => {
          selSev.value = 'passed';
          applyFilter();
        });
      }
      const errorChip = chip('errors');
      if (errorChip) {
        errorChip.addEventListener('click', () => {
          selSev.value = 'error';
          applyFilter();
        });
      }
      const allChip = chip('all');
      if (allChip) {
        allChip.addEventListener('click', () => {
          selSev.value = 'all';
          applyFilter();
        });
      }

      if (reset) {
        reset.addEventListener('click', () => {
          selSev.value = 'error';
          selSeg.value = 'all';
          txt.value = '';
          applyFilter();
        });
      }

      selSev.value = 'error';
      applyFilter();
    })();
  </script>
  <textarea id="validated-message" hidden>{{ _validated_message }}</textarea>
  <script>
    window.PipelineContext = window.PipelineContext || { message: '' };
    window.PipelineContext.setMessage = function(msg) {
      this.message = msg || '';
      var value = this.message;
      document.querySelectorAll('[data-bind="pipeline.message"]').forEach(function(el){
        if (!el) return;
        if ('value' in el) {
          if (el.value !== value) {
            el.value = value;
            try { el.dispatchEvent(new Event('input', { bubbles: true })); } catch (err) { /* ignore */ }
          }
        } else {
          el.textContent = value;
        }
      });
      if (window.PipelineBus && typeof window.PipelineBus.set === 'function') {
        try { window.PipelineBus.set('validate', value, { from: 'validate' }); } catch (err) { /* ignore */ }
      }
    };
    (function(){
      var field = document.getElementById('validated-message');
      if (field) {
        window.PipelineContext.setMessage(field.value || '');
      }
      if (window.InteropUI && typeof window.InteropUI.onValidateComplete === 'function') {
        try { window.InteropUI.onValidateComplete(); } catch (err) { /* ignore */ }
      }
    })();
  </script>

  <div class="action-tray visible" style="margin-top:1rem">
    <div class="action-tray-header">
      <h5 style="margin:0">Next steps</h5>
      <p class="text-small" style="margin:0.25rem 0 0 0">Continue with the validated message.</p>
    </div>
    <div class="action-cards" style="margin-top:0.75rem">
      <a class="action-card pipeline-run" href="#mllp-panel" data-run-to="mllp">
        <strong>📤 Send via MLLP</strong>
        <small>Deliver the validated message.</small>
      </a>
      <a class="action-card pipeline-run" href="#translate-panel" data-run-to="translate">
        <strong>🔄 HL7 → FHIR</strong>
        <small>Translate this validated message.</small>
      </a>
    </div>
  </div>
</section>

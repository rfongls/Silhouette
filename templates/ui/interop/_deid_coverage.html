<section id="deid-coverage" class="deid-coverage" hx-swap-oob="outerHTML">
  <details open class="card" style="padding:0.75rem">
    <summary class="text-h4" style="cursor:pointer">
      De-identification report
    </summary>
    {% set _rows  = (r.rows or r.data or []) %}
    {% set _total =  r.total_messages or r.msg_total or r.total or 0 %}
    {% if _rows and _rows|length > 0 %}
      <p class="text-small muted" style="margin:.5rem 0 .75rem">Coverage across {{ _total }} message{{ '' if _total == 1 else 's' }}.</p>

      <!-- Filter bar -->
      <div class="card" style="padding:.5rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.5rem">
        <label class="small">Segment
          <select class="input" id="deid-filter-seg" style="min-width:8rem">
            <option value="all">All</option>
          </select>
        </label>
        <label class="small">Field
          <select class="input" id="deid-filter-field" style="min-width:8rem">
            <option value="all">All</option>
          </select>
        </label>
        <label class="small">Action
          <select class="input" id="deid-filter-action" style="min-width:10rem">
            <option value="all">All</option>
          </select>
        </label>
        <label class="small" style="flex:1 1 320px">Value
          <input class="input" id="deid-filter-value" placeholder="Find parameter (e.g., date, name, mask…)" />
        </label>
        <span class="muted small">Across {{ _total }} message{{ '' if _total == 1 else 's' }}.</span>
      </div>

      <div class="scrollbox">
        <table style="width:100%;border-collapse:collapse;font-size:.9rem">
          <thead>
            <tr style="text-align:left;border-bottom:1px solid var(--color-border, #2b3345)">
              <th style="padding:.5rem">Segment</th>
              <th style="padding:.5rem">Field</th>
              <th style="padding:.5rem">Comp</th>
              <th style="padding:.5rem">Subcomp</th>
              <th style="padding:.5rem">Action</th>
              <th style="padding:.5rem">Logic</th>
              <th style="padding:.5rem">Total Messages</th>
            </tr>
          </thead>
          <tbody id="deid-tbody"></tbody>
        </table>
      </div>
    {% else %}
      <p class="muted" style="margin-top:.75rem">Run de-identify to see coverage by rule.</p>
    {% endif %}
  </details>

  <!-- JSON payload for the client-side renderer (scoped to this section) -->
  <script type="application/json" data-role="deid-rows" data-total="{{ _total }}">{{ _rows | tojson }}</script>

  <script>
  (function(s){
    const root   = s.closest('#deid-coverage');
    const dataEl = root.querySelector('script[data-role="deid-rows"]');
    const rows   = JSON.parse(dataEl.textContent || '[]');
    const TOTAL  = parseInt(dataEl.dataset.total || '0', 10) || 0;

    const segSel   = root.querySelector('#deid-filter-seg');
    const fieldSel = root.querySelector('#deid-filter-field');
    const actSel   = root.querySelector('#deid-filter-action');
    const valInp   = root.querySelector('#deid-filter-value');
    const tbody    = root.querySelector('#deid-tbody');

    // Build option sets
    const segSet  = new Set();
    const actSet  = new Set();
    const fieldsBySeg = new Map(); // SEG -> Set(fields)
    for (const r of rows) {
      if (r.segment) segSet.add(r.segment);
      if (r.action)  actSet.add(r.action);
      const key = r.segment || '';
      const fset = fieldsBySeg.get(key) || new Set();
      if (r.field != null) fset.add(String(r.field));
      fieldsBySeg.set(key, fset);
    }
    // Populate selects
    for (const seg of Array.from(segSet).sort()) {
      const o = document.createElement('option'); o.value = seg; o.textContent = seg; segSel.appendChild(o);
    }
    function populateFields() {
      const current = fieldSel.value;
      fieldSel.innerHTML = '<option value="all">All</option>';
      const seg = segSel.value === 'all' ? '' : segSel.value;
      const fset = fieldsBySeg.get(seg) || new Set();
      for (const f of Array.from(fset).sort((a,b)=>parseInt(a)-parseInt(b))) {
        const o = document.createElement('option'); o.value = f; o.textContent = f; fieldSel.appendChild(o);
      }
      if ([...fieldSel.options].some(o => o.value === current)) fieldSel.value = current;
    }
    populateFields();
    for (const a of Array.from(actSet).sort()) {
      const o = document.createElement('option'); o.value = a; o.textContent = a; actSel.appendChild(o);
    }

    function like(hay, needle){
      if (!needle) return true;
      hay = (hay || '').toString().toLowerCase();
      needle = needle.toString().toLowerCase().trim();
      return hay.includes(needle);
    }

    function render(){
      const wantSeg   = segSel.value;
      const wantField = fieldSel.value;
      const wantAct   = actSel.value;
      const q         = valInp.value || '';
      tbody.innerHTML = '';
      for (const r of rows) {
        if (wantSeg   !== 'all' && r.segment !== wantSeg) continue;
        if (wantField !== 'all' && String(r.field) !== wantField) continue;
        if (wantAct   !== 'all' && (r.action || '') !== wantAct) continue;
        // Value textbox matches action or logic (parameter)
        if (!like(r.logic, q) && !like(r.action, q)) continue;
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid var(--color-border, #2b3345)';
        tr.innerHTML = `
          <td style="padding:.5rem"><code class="mono">${r.segment || '—'}</code></td>
          <td style="padding:.5rem"><code class="mono">${r.field ?? '—'}</code></td>
          <td style="padding:.5rem"><code class="mono">${r.component ?? '—'}</code></td>
          <td style="padding:.5rem"><code class="mono">${r.subcomponent ?? '—'}</code></td>
          <td style="padding:.5rem">${r.action || '—'}</td>
          <td style="padding:.5rem">${r.logic || '—'}</td>
          <td style="padding:.5rem">${(r.applied||0)}/${TOTAL}</td>`;
        tbody.appendChild(tr);
      }
    }
    [segSel, fieldSel, actSel, valInp].forEach(el => el.addEventListener('input', function(){
      if (el === segSel) populateFields();
      render();
    }));
    render();
  })(document.currentScript);
  </script>
</section>

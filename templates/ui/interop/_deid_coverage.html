<section id="deid-coverage" class="deid-coverage" data-deid-root hx-swap-oob="outerHTML">
  <details open class="card" style="padding:0.75rem">
    <summary class="text-h4" style="cursor:pointer">De-identification report</summary>
    {% set _rows  = (r.rows or r.data or []) %}
    {% set _total =  r.total_messages or r.msg_total or r.total or 0 %}
    {% if _rows and _rows|length > 0 %}
      <div class="card" style="padding:.5rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:.5rem 0 .75rem">
        <label class="small">Segment
          <select class="input" data-deid-seg style="min-width:8rem">
            <option value="all">All</option>
          </select>
        </label>
        <label class="small">Field
          <select class="input" data-deid-field style="min-width:8rem">
            <option value="all">All</option>
          </select>
        </label>
        <label class="small">Action
          <select class="input" data-deid-action style="min-width:10rem">
            <option value="all">All</option>
          </select>
        </label>
        <label class="small" style="flex:1 1 320px">Value
          <input class="input" data-deid-query placeholder="Find parameter (e.g., date, name, mask…)" />
        </label>
        <button type="button" class="btn btn-xs" data-deid-reset style="margin-left:auto">Reset filters</button>
        <span class="muted small">Across {{ _total }} message{{ '' if _total == 1 else 's' }}.</span>
      </div>

      <div class="scrollbox">
        <table style="width:100%;border-collapse:collapse;font-size:.9rem">
          <thead>
            <tr style="text-align:left;border-bottom:1px solid var(--color-border, #2b3345)">
              <th style="padding:.5rem">Segment</th>
              <th style="padding:.5rem">Field</th>
              <th style="padding:.5rem">Comp</th>
              <th style="padding:.5rem">Subcomp</th>
              <th style="padding:.5rem">Action</th>
              <th style="padding:.5rem">Logic</th>
              <th style="padding:.5rem">Total Messages</th>
            </tr>
          </thead>
          <tbody data-deid-body>
            {% for it in _rows %}
              {% set _seg = it.segment or '' %}
              {% set _field_val = it.field if it.field is not none else '' %}
              {% set _action = it.action or '' %}
              {% set _logic = it.logic or '' %}
              <tr
                style="border-bottom:1px solid var(--color-border, #2b3345)"
                data-segment="{{ _seg | e }}"
                data-field="{{ _field_val | e }}"
                data-action="{{ _action | e }}"
                data-text="{{ (_action ~ ' ' ~ _logic)|lower | e }}"
              >
                <td style="padding:.5rem"><code class="mono">{{ it.segment or '—' }}</code></td>
                <td style="padding:.5rem"><code class="mono">{{ it.field if it.field is not none else '—' }}</code></td>
                <td style="padding:.5rem"><code class="mono">{{ it.component if it.component is not none else '—' }}</code></td>
                <td style="padding:.5rem"><code class="mono">{{ it.subcomponent if it.subcomponent is not none else '—' }}</code></td>
                <td style="padding:.5rem">{{ it.action or '—' }}</td>
                <td style="padding:.5rem">{{ it.logic or '—' }}</td>
                <td style="padding:.5rem">{{ it.applied | default(0) }}/{{ _total }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <script>
        (function(){
          const root = document.currentScript.closest('[data-deid-root]');
          const segSel = root.querySelector('[data-deid-seg]');
          const fieldSel = root.querySelector('[data-deid-field]');
          const actSel = root.querySelector('[data-deid-action]');
          const queryInput = root.querySelector('[data-deid-query]');
          const resetBtn = root.querySelector('[data-deid-reset]');
          const body = root.querySelector('[data-deid-body]');
          const rows = Array.from(body.querySelectorAll('tr')).map((tr) => ({
            el: tr,
            segment: tr.getAttribute('data-segment') || '',
            field: tr.getAttribute('data-field') || '',
            action: tr.getAttribute('data-action') || '',
            text: (tr.getAttribute('data-text') || '').toLowerCase(),
          }));

          const segSet = new Set();
          const actSet = new Set();
          const fieldsBySeg = new Map();
          for (const row of rows) {
            if (row.segment) segSet.add(row.segment);
            if (row.action) actSet.add(row.action);
            const key = row.segment || '';
            const bucket = fieldsBySeg.get(key) || new Set();
            if (row.field !== '') bucket.add(String(row.field));
            fieldsBySeg.set(key, bucket);
          }

          for (const seg of [...segSet].sort()) {
            segSel.add(new Option(seg, seg));
          }

          function populateFields() {
            const current = fieldSel.value;
            fieldSel.innerHTML = '<option value="all">All</option>';
            const seg = segSel.value === 'all' ? '' : segSel.value;
            const options = fieldsBySeg.get(seg) || new Set();
            for (const field of [...options].sort((a, b) => Number(a) - Number(b))) {
              fieldSel.add(new Option(field, field));
            }
            if ([...fieldSel.options].some((opt) => opt.value === current)) {
              fieldSel.value = current;
            }
          }

          populateFields();

          for (const action of [...actSet].sort()) {
            actSel.add(new Option(action, action));
          }

          function render() {
            const wantSeg = segSel.value;
            const wantField = fieldSel.value;
            const wantAction = actSel.value;
            const query = queryInput.value || '';
            const needle = query.toLowerCase().trim();
            for (const row of rows) {
              let show = true;
              if (wantSeg !== 'all' && row.segment !== wantSeg) show = false;
              if (wantField !== 'all' && String(row.field) !== wantField) show = false;
              if (wantAction !== 'all' && row.action !== wantAction) show = false;
              if (needle && !row.text.includes(needle)) show = false;
              row.el.style.display = show ? '' : 'none';
            }
          }

          [segSel, fieldSel, actSel].forEach((el) => el.addEventListener('change', () => {
            if (el === segSel) populateFields();
            render();
          }));
          queryInput.addEventListener('input', render);

          if (resetBtn) {
            resetBtn.addEventListener('click', () => {
              segSel.value = 'all';
              populateFields();
              fieldSel.value = 'all';
              actSel.value = 'all';
              queryInput.value = '';
              render();
            });
          }

          render();
        })();
      </script>
    {% else %}
      <p class="muted" style="margin-top:.75rem">Run de-identify to see coverage by rule.</p>
    {% endif %}
  </details>
</section>

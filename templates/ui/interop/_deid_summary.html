{% set rows = changes or [] %}
<section class="deid-summary">
  <header class="row wrap" style="justify-content:space-between;align-items:center">
    <h4 class="text-h4" style="margin:0">De‑identified fields ({{ rows|length }})</h4>
    <label class="small row" style="gap:.5rem">
      <span>Filter by logic</span>
      <input class="input" id="deid-filter" placeholder="e.g., NAME, PHONE, ADDRESS" style="width:18rem">
    </label>
  </header>

  {% for seg, grp in rows|groupby('segment') %}
    <details class="mt" open>
      <summary class="text-h5">{{ seg or '—' }} <span class="muted small">({{ grp.list|length }})</span></summary>
      <div class="scrollbox mt" style="border:1px solid rgba(148,163,184,.18);border-radius:.5rem">
        <table class="table small" data-deid-table>
          <thead>
            <tr>
              <th style="white-space:nowrap">Field</th>
              <th>Comp</th>
              <th>Subcomp</th>
              <th style="width:33%">Before</th>
              <th style="width:33%">After</th>
              <th>Logic</th>
            </tr>
          </thead>
          <tbody>
          {% for r in grp.list %}
            <tr>
              <td class="mono">{{ r.field if r.field is not none else '—' }}</td>
              <td class="mono">{{ r.component if r.component is not none else '—' }}</td>
              <td class="mono">{{ r.subcomponent if r.subcomponent is not none else '—' }}</td>
              <td class="mono">{{ r.before or '' }}</td>
              <td class="mono">{{ r.after or '' }}</td>
              <td class="mono" data-logic="{{ (r.logic or r.rule or '') | upper }}">{{ r.logic or r.rule or '—' }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </details>
  {% else %}
    <p class="muted small" style="margin-top:1rem">No changes detected.</p>
  {% endfor %}
</section>
<script>
  (function(){
    const inp = document.getElementById('deid-filter');
    if (!inp) return;
    const tables = Array.from(document.querySelectorAll('[data-deid-table]'));
    function apply(){
      const q = (inp.value || '').trim().toUpperCase();
      for (const tbl of tables){
        for (const tr of tbl.tBodies[0].rows){
          const logic = (tr.querySelector('td[data-logic]')?.dataset.logic || '');
          tr.style.display = (!q || logic.includes(q)) ? '' : 'none';
        }
      }
    }
    inp.addEventListener('input', apply);
  })();
</script>

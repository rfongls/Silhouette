{% extends "layout.html" %}

{% block extra_head %}
<link rel="stylesheet" href="{{ request.url_for('static', path='css/interop_extras.css') }}" />
<link rel="stylesheet" href="{{ request.url_for('static', path='standalone_1006.css') }}" />
<script type="module" src="{{ request.url_for('static', path='standalone_1006.js') }}"></script>
{% endblock %}

{% block content %}
{% if urls is not defined %}
  {% set urls = {} %}
{% endif %}
{% set root = request.scope.get('root_path', '') %}
{% set presets = presets or {} %}
{% set preset_key = preset_key or '' %}
{% set defaults = defaults or {} %}
<section class="dashboard">
  <div class="dashboard-container">
    <nav class="breadcrumbs"><a href="{{ root }}/ui/interop">Interoperability</a> / <span>Standalone Pipeline</span></nav>
    <header class="dashboard-header">
      <h1 class="text-h1">HL7 Test Bench</h1>
      <p class="text-body muted">Generate messages, de-identify, validate, and send over transport — exactly like the legacy QA bench.</p>
    </header>

    <form class="row gap mb small" method="get" action="{{ urls.ui_pipeline | default(root ~ '/ui/interop/pipeline', true) }}">
      <label for="pipeline-preset" class="sr-only">Pipeline preset</label>
      <select id="pipeline-preset" name="preset" class="input" onchange="this.form.submit()">
        <option value="">— Select transport preset —</option>
        {% for key, preset in presets.items() %}
          <option value="{{ key }}" {% if key == preset_key %}selected{% endif %}>{{ preset.label }}</option>
        {% endfor %}
      </select>
      <span class="micro muted">Presets prefill the pipeline transport host, port, timeout, and FHIR endpoint.</span>
    </form>

    {% set r = {
      'rows': [],
      'data': [],
      'total_messages': 0,
      'msg_total': 0,
      'total': 0,
      'segment_options': [],
      'fields_by_segment': {'__all__': []},
      'action_options': [],
      'summary': {'rows': []},
      'summary_rows': [],
      'issues': [],
      'counts': {},
    } %}

    <div class="grid grid-cols-1 gap-4 legacy-interop-skin">
      {% include "ui/interop/_generate_panel.html" %}
      <div id="gen_output" class="card">
        <div class="card-body">
          <textarea id="hl7_text" class="w-full h-48" placeholder="Generated HL7 message will appear here"></textarea>
        </div>
      </div>
      <div class="action-tray" data-tray="gen_output">
        <button class="btn btn-primary" data-next="deid">Next: De-identify</button>
        <button class="btn" data-next="validate">Skip to Validate</button>
      </div>

      {% include "ui/interop/_deid_panel.html" %}
      <div id="deid_output" class="card">
        <div class="card-body"></div>
      </div>
      <div class="action-tray" data-tray="deid_output">
        <button class="btn btn-primary" data-next="validate">Next: Validate</button>
        <button class="btn" data-next="mllp">Send via MLLP</button>
      </div>

      {% include "ui/interop/_validate_panel.html" %}
      <div id="validate_output" class="card">
        <div class="card-body"></div>
      </div>
      <div class="action-tray" data-tray="validate_output">
        <button class="btn btn-primary" data-next="mllp">Next: Send via MLLP</button>
      </div>

      {% include "ui/interop/_mllp_panel.html" %}
      {% include "ui/interop/_debug_log_panel.html" %}
      {% include "ui/interop/_analyze_result.html" %}
    </div>
  </div>
</section>
{% endblock %}

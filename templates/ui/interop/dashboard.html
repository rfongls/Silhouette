{% extends "layout.html" %}
{% block extra_head %}
<link rel="stylesheet" href="{{ request.url_for('static', path='css/interop_extras.css') }}" />
<script type="module" src="{{ request.url_for('static', path='js/interop_ui.js') }}"></script>
{% endblock %}
{% block content %}
{% if urls is not defined %}
  {% set urls = {} %}
{% endif %}
{% set root = request.scope.get('root_path', '') %}
<div class="row mb" style="justify-content: space-between; align-items: center; gap: 1rem;">
  <h2>Interoperability Dashboard</h2>
  <div class="row gap" style="align-items: center;">
    <a class="btn btn-secondary" href="{{ link_for(request, 'ui_reports', '/reports') }}">View reports</a>
    <span id="debug-state-badge"
          hx-get="{{ request.url_for('api_diag_debug_state') }}?format=html"
          hx-trigger="load"
          hx-target="this"
          hx-swap="outerHTML">
      <span class="micro muted">Loading debug switch…</span>
    </span>
  </div>
</div>
<div class="row gap mt">
  <label><input type="checkbox" class="feature-toggle" data-target="deid" checked/> De-ID</label>
  <label><input type="checkbox" class="feature-toggle" data-target="validate" checked/> Validate</label>
</div>
<div class="grid">
  <section class="card">
    <h3>HL7 Sample Finder</h3>
    <form id="sample-search" class="row gap"
          hx-get="{{ root }}/ui/interop/samples"
          hx-target="#sample-results"
          hx-swap="innerHTML"
          hx-trigger="keyup changed delay:250ms, change from:#sample-version">
      <label for="sample-version" class="label">Version</label>
      <select id="sample-version" name="version" class="input hl7-version-select" data-hx-refresh-target="1">
        <option value="hl7-v2-3">HL7 v2.3</option>
        <option value="hl7-v2-4" selected>HL7 v2.4</option>
        <option value="hl7-v2-5">HL7 v2.5</option>
      </select>

      <input id="sample-q" class="input grow" type="text" name="q"
             placeholder="Type to search (e.g., ADT_A01, ORU_R01)"/>
    </form>

    <div id="sample-results"
         hx-get="{{ root }}/ui/interop/samples"
         hx-vals='{"version":"hl7-v2-4"}'
         hx-trigger="load"
         hx-target="this"
         hx-swap="innerHTML">
      <!-- results will render here -->
    </div>

    <div class="grid2 mt">
      <div>
        <h4>Preview</h4>
        <pre id="sample-preview" class="codepane muted">Select a sample…</pre>
      </div>
      <div>
        <h4>Insert</h4>
        <div id="sample-inject" class="muted">
          Choose “Insert” to load the sample text into this panel (wire to your textarea/editor if desired).
        </div>
      </div>
    </div>
  </section>

  <section class="card interop-card-generate">
    {% include "ui/interop/_generate_panel.html" %}
  </section>
  <section class="card interop-card-deid">
    {% include "ui/interop/_deid_panel.html" %}
  </section>
  <section class="card interop-card-validate">
    {% include "ui/interop/_validate_panel.html" %}
  </section>
  <section class="card">
    <h3>Recent Activity</h3>
    <div id="interop-activity"
         hx-get="/api/diag/activity?format=html&limit=20"
         hx-trigger="load, every 15s"
         hx-swap="outerHTML">
      <div class="muted small">Loading recent activity…</div>
    </div>
  </section>
  <section class="card">
    <h3>Alerts &amp; Issues</h3>
    <div id="interop-debug-log"
         hx-get="{{ root }}/ui/home/debug-log?target=interop-debug-log"
         hx-trigger="load, every 20s"
         hx-swap="outerHTML">
      <div class="muted small">Loading generator diagnostics…</div>
    </div>
  </section>
  <section class="card interop-card-mllp">
    {% include "ui/interop/_mllp_panel.html" %}
  </section>
  <div class="card">
    <h3>HL7 → FHIR Pipeline</h3>
    <p class="muted">Select/Generate → Analyze → Translate → (optional) POST</p>
    <a class="btn" href="{{ root }}/ui/interop/pipeline">Open Pipeline</a>
  </div>

  <div class="card">
    <h3>Trigger Descriptions</h3>
    <a class="btn btn-xs" href="{{ root }}/interop/triggers/csv">Download CSV</a>
    <div id="trigger-admin" class="mt" hx-get="{{ root }}/ui/interop/trigger-admin" hx-trigger="load" hx-target="this" hx-swap="innerHTML"></div>
  </div>
  <div class="card">
    <h3>Quick Start</h3>
    <p class="muted">One-click pipeline: Draft example HL7 → FHIR Translate → Validate. No listener required.</p>
    <form action="{{ root }}/interop/quickstart" method="post"
          hx-post="{{ root }}/interop/quickstart"
          hx-target="#pipeline-result"
          hx-swap="innerHTML">
      <div class="row gap">
        <label class="label">Version</label>
        <select name="version" class="input hl7-version-select" id="qs-version" data-hx-refresh-target="1"
          hx-get="{{ root }}/ui/interop/triggers"
          hx-target="#qs-trigger"
          hx-trigger="load, change"
          onchange="window.InteropUI.fillDatalist('qs')">
          <option value="hl7-v2-3">HL7 v2.3</option>
          <option value="hl7-v2-4" selected>HL7 v2.4</option>
          <option value="hl7-v2-5">HL7 v2.5</option>
        </select>
        <label class="label">Trigger</label>
        <div class="row gap">
          <select name="trigger" class="input" id="qs-trigger"
                hx-get="{{ root }}/ui/interop/triggers"
                hx-target="#qs-trigger"
                hx-trigger="load, change from:#qs-version"
                hx-include="#qs-version">
          </select>
          <!-- typeahead -->
          <input class="input" list="qs-trigger-datalist" id="qs-trigger-typed" placeholder="Type trigger e.g. ADT_A01" oninput="window.InteropUI.syncTyped('qs')"/>
          <datalist id="qs-trigger-datalist"></datalist>
        </div>
      </div>
      <div class="row gap mt">
        <input class="input" type="number" name="seed" value="1337" title="seed (deterministic)" />
        <label><input type="checkbox" name="ensure_unique" checked /> Unique IDs</label>
        <label><input type="checkbox" name="include_clinical" checked /> Enrich clinical</label>
        <label><input type="checkbox" name="deidentify" /> De-identify</label>
      </div>
      <button type="submit">Run Pipeline</button>
      <button type="button" hx-post="{{ root }}/interop/demo/seed" hx-target="#pipeline-demo" hx-swap="innerHTML">Load Demo</button>
    </form>
    <div id="pipeline-demo" class="muted"></div>
    <div id="pipeline-result" class="result"></div>
  </div>

  <div class="card">
    <h3>Analyze HL7</h3>
    <p class="muted">Quick segment summary for uploaded HL7 file(s).</p>
    <form action="/interop/hl7/analyze" method="post"
          hx-post="/interop/hl7/analyze"
          hx-target="#draft-result"
          hx-swap="innerHTML"
          enctype="multipart/form-data">
      <input type="file" name="hl7_files" multiple />
      <button type="submit">Analyze</button>
    </form>
    <div id="draft-result" class="result"></div>
  </div>

  <div class="card">
    <h3>Draft &amp; Send HL7</h3>
    <p class="muted">Create a standards-conformant HL7 message for a given trigger and send via MLLP. Pick a sample below to auto-fill valid content.</p>
    <form action="/interop/hl7/draft-send" method="post"
          hx-post="/interop/hl7/draft-send"
          hx-target="#draft-result" hx-swap="innerHTML">
      <div class="row gap">
        <input type="text" name="message_type" id="ds-trigger-input" placeholder="ADT_A01" value="ADT_A01" />
        <select class="input" id="ds-trigger-select"
                hx-get="/ui/interop/triggers"
                hx-target="#ds-trigger-select"
                hx-trigger="load, change from:#sample-version"
                hx-include="#sample-version">
        </select>
        <script>
          (function(){
            const v = document.getElementById('sample-version');
            if (v) v.addEventListener('change', () => window.InteropUI.fillDatalist('ds'));
          })();
        </script>
        <button class="btn" type="button"
                onclick="var sel=document.getElementById('ds-trigger-select'); var v=sel && sel.value || ''; if(v){document.getElementById('ds-trigger-input').value=v;}">
          Use Selected
        </button>
        <input class="input" list="ds-trigger-datalist" id="ds-trigger-typed" placeholder="Type trigger" oninput="window.InteropUI.syncTyped('ds')"/>
        <datalist id="ds-trigger-datalist"></datalist>
      </div>
      <label>JSON Data <small>(Click an Example below)</small></label>
      <textarea name="json_data" id="hl7-json" rows="14" placeholder="{}"></textarea>
      <div style="display:flex; gap:.5rem; align-items:center; margin:.25rem 0 .75rem;">
        <label for="hl7-ex">Example:</label>
        <select id="hl7-ex" onchange="import('/static/js/examples.js').then(m=>m.loadExample(this,'#hl7-json'));"><option value="">— choose —</option>
          <option value="/static/examples/hl7/json/ADT_A01_min.json">ADT_A01 — Admit/Visit Start</option>
          <option value="/static/examples/hl7/json/ADT_A03_min.json">ADT_A03 — Discharge</option>
          <option value="/static/examples/hl7/json/ORM_O01_min.json">ORM_O01 — General Order</option>
          <option value="/static/examples/hl7/json/ORU_R01_lab.json">ORU_R01 — Lab Result (LOINC)</option>
          <option value="/static/examples/hl7/json/VXU_V04_min.json">VXU_V04 — Immunization Update</option>
        </select>
        <a href="/static/examples/hl7/samples/ADT_A01.hl7" download>Download ADT_A01.hl7</a>
      </div>
      <input type="text" name="host" placeholder="127.0.0.1" value="127.0.0.1" />
      <input type="number" name="port" placeholder="2575" value="2575" />
      <button type="submit">Send</button>
    </form>
    <details>
      <summary>Send a whole folder</summary>
      <form action="/interop/hl7/send-batch" method="post" hx-post="/interop/hl7/send-batch" hx-target="#draft-result" hx-swap="innerHTML" enctype="multipart/form-data">
        <input type="file" name="hl7_files" webkitdirectory directory multiple />
        <input type="text" name="host" value="127.0.0.1" />
        <input type="number" name="port" value="2575" />
        <button type="submit">Send Folder</button>
      </form>
    </details>
    <div id="draft-result" class="result"></div>
  </div>

  <div class="card">
    <h3>Translate</h3>
    <p class="muted">Convert HL7 v2 ➜ FHIR. Upload a .hl7 file; choose bundle mode. Optionally validate against the configured IGs.</p>
    <form action="/interop/translate" method="post" hx-post="/interop/translate" hx-target="#translate-result" hx-swap="innerHTML" enctype="multipart/form-data">
      <input type="file" name="hl7_file" />
      <select name="bundle">
        <option value="transaction">transaction</option>
        <option value="collection">collection</option>
      </select>
      <label><input type="checkbox" name="validate" value="true" />validate</label>
      <input type="text" name="out_dir" value="out/interop/ui" />
      <button type="submit">Translate</button>
    </form>
    <details>
      <summary>Translate a whole folder</summary>
      <form action="/interop/translate-batch" method="post" hx-post="/interop/translate-batch" hx-target="#translate-result" hx-swap="innerHTML" enctype="multipart/form-data">
        <input type="file" name="hl7_files" webkitdirectory directory multiple />
        <select name="bundle">
          <option value="transaction">transaction</option>
          <option value="collection">collection</option>
        </select>
        <label><input type="checkbox" name="validate_after" value="true" /> Validate after translate</label>
        <input type="text" name="out_dir" value="out/interop/ui" />
        <button type="submit">Translate Folder</button>
      </form>
    </details>
    <p class="muted">No file handy? Download a sample: <a href="/static/examples/hl7/samples/ORU_R01.hl7" download>ORU_R01.hl7</a> · <a href="/static/examples/hl7/samples/VXU_V04.hl7" download>VXU_V04.hl7</a></p>
    <div id="translate-result" class="result"></div>
  </div>

  <div class="card">
    <h3>Validate</h3>
    <p class="muted">Upload one or more FHIR resources to validate. Results show rc/stdout/stderr from the validator.</p>
    <form action="/interop/validate" method="post" hx-post="/interop/validate" hx-target="#validate-result" hx-swap="innerHTML" enctype="multipart/form-data">
      <input type="file" name="fhir_files" multiple />
      <input type="text" name="out_dir" value="out/interop/ui" />
      <button type="submit">Validate</button>
    </form>
    <div style="margin:.5rem 0;">
      <button type="button" hx-post="/interop/validate-last" hx-target="#validate-result" hx-swap="innerHTML">Validate Last Translate Output</button>
    </div>
    <p class="muted">Sample bundle: <a href="/static/examples/fhir/bundle.json" download>FHIR Bundle</a></p>
    <div id="validate-result" class="result"></div>
  </div>

  <div class="card">
    <h3>Directory Watcher</h3>
    <p class="muted">Auto-translate new .hl7 files that appear in a directory (optional validate).</p>
    <form action="/interop/watch/start" method="post" hx-post="/interop/watch/start" hx-target="#watch-status" hx-swap="innerHTML">
      <input type="text" name="in_dir" value="in/hl7" />
      <input type="text" name="out_dir" value="out/interop/watch" />
      <select name="bundle"><option>transaction</option><option>collection</option></select>
      <label><input type="checkbox" name="validate_after" value="true" /> Validate after translate</label>
      <button type="submit">Start Watcher</button>
      <button type="button" hx-post="/interop/watch/stop" hx-target="#watch-status" hx-swap="innerHTML">Stop</button>
      <button type="button" hx-get="/interop/watch/status" hx-target="#watch-status" hx-swap="innerHTML">Status</button>
    </form>
    <div id="watch-status" class="result"></div>
  </div>

  <div class="card">
    <h3>FHIR API (Read)</h3>
    <p class="muted">Test reading a resource from a FHIR API (GET). Provide base URL and resource like <code>Patient/123</code>.</p>
    <form action="/interop/fhir/read" method="post" hx-post="/interop/fhir/read" hx-target="#fhir-read" hx-swap="innerHTML">
      <input type="text" name="base" placeholder="https://fhir.example.org/fhir" />
      <input type="text" name="resource" placeholder="Patient/123" />
      <input type="password" name="token" placeholder="Bearer token (optional)" />
      <button type="submit">Read</button>
    </form>
    <div id="fhir-read" class="result"></div>
  </div>
</div>
{% endblock %}


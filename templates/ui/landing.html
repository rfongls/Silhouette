{% extends "layout.html" %}
{% block content %}
<section class="dashboard">
  <div class="dashboard-container">
    <header class="dashboard-header">
      <h1 class="text-h1">Welcome</h1>
      <p class="text-body">Drive the Engine via <strong>Chat (beta)</strong>, jump into the manual UI, or skim examples in <code>docs/v2/README-agent.md</code>.</p>
      <div class="row small" style="gap:.5rem">
        <a class="btn btn-secondary btn-sm" href="/ui/engine">Open Engine (manual)</a>
      </div>
    </header>

    <style>
      .two-col { display:grid; grid-template-columns: 1.1fr .9fr; gap: 1rem; align-items:start; }
      .timeline { max-height: 460px; overflow:auto; border:1px solid #333; padding:.5rem; border-radius:.375rem; background:#0a0a0a;}
      .log { font-family: ui-monospace, Menlo, monospace; font-size: .9rem; }
      .badge { background:#1f2933; color:#e4e7eb; padding:.1rem .4rem; border-radius:.25rem; display:inline-block; }
      .badge.ok { background:#1b7f4d; color:#ecfdf5; }
      .badge.err { background:#9b1c1c; color:#fee2e2; }
      .qa { display:inline-flex; gap:.25rem; margin-left:.5rem; }
      .timeline a { color:#7dd3fc; text-decoration:none; }
      .timeline a:hover { text-decoration:underline; }
      .failure-details { margin-top:.25rem; }
      .failure-details ul { margin:.25rem 0 0 1.25rem; padding:0; }
      .failure-details li { list-style:disc; }
      .btn.btn-xs { font-size:.75rem; padding:.15rem .4rem; border-radius:.25rem; }
      .muted { opacity: .85; }
      .mono { font-family: ui-monospace, Menlo, monospace; }
      .card-subtitle { margin: .25rem 0 .5rem 0; }
    </style>

    <div class="two-col">
      <!-- Left: Chat -->
      <section class="card">
        <h2 class="text-h2">Chat (beta)</h2>
        <p class="text-body muted card-subtitle">Type a command, preview steps, and run — confirmations will appear on the right.</p>
        <textarea id="agent-input" class="input" style="width:100%;height:7rem" placeholder="e.g. create inbound adt-in on 127.0.0.1:4321 for pipeline 3 allow 127.0.0.1/32"></textarea>
        <div class="row small" style="gap:.5rem;margin-top:.5rem">
          <button class="btn btn-secondary btn-sm" id="agent-preview">Preview steps</button>
          <button class="btn btn-primary btn-sm" id="agent-run">Run</button>
        </div>
        <div style="margin-top:.75rem">
          <h3 class="text-h3">Planned steps</h3>
          <pre id="agent-plan" class="log">—</pre>
        </div>
        <div style="margin-top:.5rem">
          <h3 class="text-h3">Result</h3>
          <pre id="agent-result" class="log">—</pre>
        </div>
      </section>

      <!-- Right: Live Activity -->
      <section class="card">
        <h2 class="text-h2">Activity Timeline</h2>
        <div id="activity" class="timeline log">
          <div class="muted">Waiting for actions…</div>
        </div>
      </section>
    </div>
  </div>
</section>

<script>
  const $ = (s) => document.querySelector(s);
  function esc(s){ const t=document.createElement('div'); t.textContent=String(s ?? ''); return t.innerHTML; }
  function linkHtml(href, label){
    const a = document.createElement('a');
    a.href = href;
    a.textContent = label;
    return a.outerHTML;
  }
  function set(el, text){ if (el) el.textContent = text; }
  const activityBox = $('#activity');
  const seenActionIds = new Set();
  const seenActionOrder = [];
  const MAX_SEEN_IDS = 500;

  function renderAction(data) {
    if (!data || !activityBox || seenActionIds.has(data.id)) return;
    if (activityBox.firstElementChild && activityBox.firstElementChild.classList.contains('muted')) {
      activityBox.innerHTML = '';
    }
    seenActionIds.add(data.id);
    seenActionOrder.push(data.id);
    if (seenActionOrder.length > MAX_SEEN_IDS) {
      const expired = seenActionOrder.shift();
      if (expired !== undefined) {
        seenActionIds.delete(expired);
      }
    }
    const line = document.createElement('div');
    const when = esc(new Date(data.ts).toLocaleTimeString());
    const id = esc(data.id);
    const intent = esc(data.intent ?? '');
    const status = String(data.status ?? '').toLowerCase();
    let badgeHtml = '<span class="badge">—</span>';
    if (status === 'succeeded') badgeHtml = '<span class="badge ok">ok</span>';
    else if (status === 'failed') badgeHtml = '<span class="badge err">err</span>';
    else if (status) badgeHtml = `<span class="badge">${esc(status)}</span>`;
    let noteParts = [];
    let failureItems = [];
    if (data.endpoint_id) {
      const endpointId = Number(data.endpoint_id);
      if (!Number.isNaN(endpointId) && endpointId > 0) {
        const href = `/ui/engine?focus=${encodeURIComponent(`endpoint:${endpointId}`)}`;
        noteParts.push(linkHtml(href, `endpoint #${endpointId}`));
      } else {
        noteParts.push(`endpoint #${esc(data.endpoint_id)}`);
      }
    }
    if (data.job_id) {
      const jobId = Number(data.job_id);
      if (!Number.isNaN(jobId) && jobId > 0) {
        const href = `/ui/engine?focus=${encodeURIComponent(`job:${jobId}`)}`;
        noteParts.push(linkHtml(href, `job #${jobId}`));
      } else {
        noteParts.push(`job #${esc(data.job_id)}`);
      }
    }
    if (data.run_id) {
      const runId = Number(data.run_id);
      if (!Number.isNaN(runId) && runId > 0) {
        const href = `/ui/engine?focus=${encodeURIComponent(`run:${runId}`)}`;
        noteParts.push(linkHtml(href, `run #${runId}`));
      } else {
        noteParts.push(`run #${esc(data.run_id)}`);
      }
    }
    const summary = data?.result?.summary;
    if (summary && typeof summary === 'object') {
      const summaryParts = [];
      for (const [key, value] of Object.entries(summary)) {
        if (value === undefined || value === null) continue;
        if (Array.isArray(value)) {
          if (key === 'failures') {
            failureItems = value.map((item) => String(item));
            summaryParts.push(`${esc(key)}=${esc(value.length)}`);
          } else {
            summaryParts.push(`${esc(key)}=${esc(value.length)}`);
          }
        } else if (typeof value === 'object') {
          summaryParts.push(`${esc(key)}=…`);
        } else {
          summaryParts.push(`${esc(key)}=${esc(value)}`);
        }
      }
      if (summaryParts.length) {
        noteParts.push(summaryParts.join(', '));
      }
    }
    const note = noteParts.length ? ` · ${noteParts.join(' · ')}` : '';
    let qaHtml = '';
    if (data.endpoint_id) {
      const endpointId = Number(data.endpoint_id);
      if (!Number.isNaN(endpointId) && endpointId > 0) {
        qaHtml += `<span class="qa">
          <button class="btn btn-secondary btn-xs" data-qa="start_ep" data-ep="${endpointId}" title="Start endpoint">Start</button>
          <button class="btn btn-secondary btn-xs" data-qa="stop_ep" data-ep="${endpointId}" title="Stop endpoint">Stop</button>
          <button class="btn btn-secondary btn-xs" data-qa="del_ep" data-ep="${endpointId}" title="Delete endpoint">Delete</button>
        </span>`;
      }
    }
    if (data.job_id) {
      const jobId = Number(data.job_id);
      if (!Number.isNaN(jobId) && jobId > 0) {
        qaHtml += `<span class="qa">
          <button class="btn btn-secondary btn-xs" data-qa="cancel_job" data-job="${jobId}" title="Cancel job">Cancel</button>
        </span>`;
      }
    }
    line.innerHTML = `[${when}] #${id} ${badgeHtml} <strong>${intent}</strong>${note} ${qaHtml}`;
    if (failureItems.length) {
      const details = document.createElement('details');
      details.className = 'failure-details';
      const summaryEl = document.createElement('summary');
      summaryEl.textContent = `Failed files (${failureItems.length})`;
      const list = document.createElement('ul');
      failureItems.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        list.appendChild(li);
      });
      details.appendChild(summaryEl);
      details.appendChild(list);
      line.appendChild(details);
    }
    activityBox.appendChild(line);
    activityBox.scrollTop = activityBox.scrollHeight;
  }

  async function interpretCmd() {
    const text = $('#agent-input').value || '';
    const res = await fetch('/api/agent/interpret', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({text})});
    if (!res.ok) { set($('#agent-plan'), await res.text()); return null; }
    const data = await res.json();
    set($('#agent-plan'), JSON.stringify(data, null, 2));
    return data;
  }
  async function runCmd(preview) {
    if (!preview) return;
    const payload = {
      intent: preview.intent,
      params: {...preview.params},
      dry_run: false,
      steps: (preview.steps || []).map(step => ({
        action: step.action,
        args: {...(step.args || {})}
      }))
    };
    const res = await fetch('/api/agent/execute', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
    if (!res.ok) { set($('#agent-result'), await res.text()); return; }
    const data = await res.json();
    set($('#agent-result'), JSON.stringify(data, null, 2));
  }
  $('#agent-preview')?.addEventListener('click', interpretCmd);
  $('#agent-run')?.addEventListener('click', async () => {
    const preview = await interpretCmd();
    await runCmd(preview);
  });

  // SSE Timeline
  async function loadRecentActions() {
    if (!activityBox) return 0;
    try {
      const res = await fetch('/api/agent/actions?limit=20');
      if (!res.ok) return 0;
      const payload = await res.json();
      const items = Array.isArray(payload.items) ? payload.items : [];
      if (!items.length) return 0;
      activityBox.innerHTML = '';
      items.sort((a, b) => a.id - b.id).forEach(renderAction);
      return items[items.length - 1].id;
    } catch (err) {
      console.warn('recent activity fetch failed', err);
      return 0;
    }
  }

  async function initActivityStream() {
    const lastId = await loadRecentActions();
    try {
      const streamUrl = lastId ? `/api/agent/actions/stream?since=${encodeURIComponent(lastId)}` : '/api/agent/actions/stream';
      const ev = new EventSource(streamUrl);
      if (activityBox) activityBox.innerHTML = activityBox.innerHTML || '';
      ev.addEventListener('action', (e) => {
        const data = JSON.parse(e.data || '{}');
        renderAction(data);
      });
      ev.onerror = () => {};
    } catch (err) {
      console.warn('SSE init failed', err);
    }
  }

  initActivityStream();

  document.addEventListener('click', async (event) => {
    const target = event.target;
    if (!(target instanceof HTMLButtonElement)) return;
    const action = target.dataset.qa;
    if (!action) return;
    let payload = null;
    if (action === 'start_ep' || action === 'stop_ep' || action === 'del_ep') {
      const endpointId = Number(target.dataset.ep || '0');
      if (!endpointId) return;
      const stepAction = action === 'start_ep' ? 'start_endpoint' : action === 'stop_ep' ? 'stop_endpoint' : 'delete_endpoint';
      payload = {
        intent: stepAction,
        params: { endpoint_id: endpointId },
        dry_run: false,
        steps: [
          {
            action: stepAction,
            args: { endpoint_id: endpointId }
          }
        ]
      };
    } else if (action === 'cancel_job') {
      const jobId = Number(target.dataset.job || '0');
      if (!jobId) return;
      payload = {
        intent: 'cancel_job',
        params: { job_id: jobId },
        dry_run: false,
        steps: [
          {
            action: 'cancel_job',
            args: { job_id: jobId }
          }
        ]
      };
    }
    if (!payload) return;
    try {
      const res = await fetch('/api/agent/execute', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        console.warn('quick action failed', await res.text());
      }
    } catch (err) {
      console.warn('quick action error', err);
    }
  });
</script>
{% endblock %}

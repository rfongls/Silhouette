{% extends "layout.html" %}
{% block content %}
<h2>Security Dashboard</h2>
<div hx-get="/security/summary" hx-trigger="load, every 10s" hx-target="#kpi-wrap" hx-swap="innerHTML"></div>
<div id="kpi-wrap"></div>
<div class="grid">
  <div class="card">
    <h3>Quick Start</h3>
    <p class="muted">Use <strong>Baseline</strong> to get an immediate snapshot (Gate ➜ Recon-safe) or <strong>Load Demo</strong> for offline sample results.</p>
    <form hx-post="/security/baseline" hx-target="#baseline-result" hx-swap="innerHTML">
      <input type="text" name="target" placeholder="example.com" />
      <input type="text" name="scope_file" value="docs/cyber/scope_example.txt" />
      <input type="hidden" name="profile" value="safe" />
      <input type="hidden" name="out_dir" value="out/security/ui" />
      <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin:.25rem 0;">
        <button type="submit">Run Baseline</button>
        <button type="button" hx-post="/security/demo/seed" hx-target="#baseline-demo-msg" hx-swap="innerHTML">Load Demo</button>
      </div>
    </form>
    <div id="baseline-demo-msg" class="muted"></div>
    <div id="baseline-result" class="result"></div>
  </div>
  <div class="card">
    <h3>Gate</h3>
    <p class="muted">Access control pre-check. Confirms target is in scope and properly authorized before any active action.</p>
    <ul class="muted"><li><strong>Target</strong>: Host/IP (e.g., example.com)</li><li><strong>Scope file</strong>: Allowed targets list</li><li><strong>Authorization Doc</strong>: Upload signed approval</li></ul>
    <form hx-post="/security/gate" hx-target="#gate-result" hx-swap="innerHTML" enctype="multipart/form-data">
      <input type="text" name="target" placeholder="target" />
      <input type="text" name="scope_file" value="docs/cyber/scope_example.txt" />
      <input type="file" name="auth_doc" />
      <input type="text" name="out_dir" value="out/security/ui" />
      <button type="submit">Run</button>
    </form>
    <div id="gate-result" class="result"></div>
  </div>
  <div class="card">
    <h3>Recon</h3>
    <p class="muted">Discovery scan (profiles: <code>safe</code>, <code>version</code>, <code>full</code>). Use stream to watch progress live.</p>
    <form hx-post="/security/recon" hx-target="#recon-result" hx-swap="innerHTML">
      <input type="text" name="target" placeholder="example.com" />
      <input type="text" name="scope_file" value="docs/cyber/scope_example.txt" />
      <select name="profile">
        <option value="safe">safe</option>
        <option value="version">version</option>
        <option value="full">full</option>
      </select>
      <input type="text" name="out_dir" value="out/security/ui" />
      <button type="submit">Run</button>
      <button type="button" onclick="
        (function(){
          const out = document.getElementById('recon-stream');
          out.textContent = 'Starting stream...';
          const form = this.closest('form');
          const data = new FormData(form);
          const query = new URLSearchParams(Array.from(data.entries())).toString();
          const es = new EventSource('/security/recon-stream?' + query);
          es.onmessage = (e) => { out.textContent += (out.textContent ? '\n' : '') + e.data; };
          es.onerror = () => { out.textContent += '\n[stream closed]'; es.close(); htmx.ajax('GET','/security/summary',{target:'#kpi-wrap',swap:'innerHTML'}); };
        })();
      ">Stream Recon</button>
    </form>
    <div id="recon-result" class="result"></div>
    <pre id="recon-stream" class="result"></pre>
  </div>
  <div class="card">
    <h3>Netforensics</h3>
    <p class="muted">Upload a <code>.pcap</code>. The summary shows packet/flow counts and alerts; full JSON available under “Raw JSON”.</p>
    <form hx-post="/security/netforensics" hx-target="#net-result" hx-swap="innerHTML" enctype="multipart/form-data">
      <input type="file" name="pcap" />
      <input type="text" name="out_dir" value="out/security/ui" />
      <button type="submit">Run</button>
    </form>
    <div id="net-result" class="result"></div>
  </div>
  <div class="card">
    <h3>IR Playbook</h3>
    <p class="muted">Choose a scenario to generate steps and schedule stubs (e.g., ransomware, credential, PII).</p>
    <form hx-post="/security/ir" hx-target="#ir-result" hx-swap="innerHTML">
      <select name="incident">
        <option value="ransomware">ransomware</option>
        <option value="credential">credential</option>
        <option value="pii">pii</option>
      </select>
      <input type="text" name="out_dir" value="out/security/ui" />
      <button type="submit">Run</button>
    </form>
    <div id="ir-result" class="result"></div>
  </div>
  <div class="card">
    <h3>Bulk Recon</h3>
    <form id="bulk-form">
      <label>Targets (one per line)</label>
      <textarea name="targets" rows="6" placeholder="sub1.example.com&#10;sub2.example.com"></textarea>
      <input type="text" name="scope_file" value="docs/cyber/scope_example.txt" />
      <select name="profile">
        <option value="safe">safe</option>
        <option value="version">version</option>
        <option value="full">full</option>
      </select>
      <input type="text" name="out_dir" value="out/security/ui" />
      <button type="button" onclick="
        (function(){
          const form = document.getElementById('bulk-form');
          const out = document.getElementById('bulk-stream');
          const query = new URLSearchParams(new FormData(form)).toString();
          const es = new EventSource('/security/recon-bulk-stream?' + query);
          es.onmessage = (e)=>{ out.textContent += (out.textContent? '\n':'') + e.data; };
          es.onerror = ()=>{ out.textContent += '\n[stream closed]'; es.close(); htmx.ajax('GET','/security/summary',{target:'#kpi-wrap',swap:'innerHTML'}); };
        })();">Stream Bulk</button>
    </form>
    <pre id="bulk-stream" class="result"></pre>
  </div>
</div>
{% endblock %}

<!DOCTYPE html>
<html lang="en" data-theme="light">
{# Fallback for static URLs if a handler ever forgets 'request' #}
{% set static_base = request.url_for('static', path='') if request is defined else '/static/' %}
{% set req = request if request is defined else none %}
{% set root = req.scope.get('root_path', '') if req else '' %}
{% set current_path = req.url.path if req and req.url else '' %}
{% set home_url = link_for(req, 'ui_home', '/ui/home') %}
{% set skills_url = link_for(req, 'ui_skills_index', '/ui/skills') %}
{% set interop_url = link_for(req, 'interop_skills', '/ui/interop/skills') %}
{% set reports_url = link_for(req, 'ui_reports', '/reports') %}
{% set settings_url = link_for(req, 'ui_settings_index', '/ui/settings') %}
{% set home_path = root ~ '/ui/home' %}
{% set skills_path = root ~ '/ui/skills' %}
{% set interop_path = root ~ '/ui/interop' %}
{% set reports_path = root ~ '/reports' %}
{% set settings_path = root ~ '/ui/settings' %}
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Silhouette UI</title>
  <meta name="root-path" content="{{ root }}" />
  <meta name="app-root" content="{{ root }}" />
  <link rel="stylesheet" href="{{ static_base }}css/app.css" />
  <link rel="stylesheet" href="{{ static_base }}css/dashboard.css" />
  <style>
    .badge {
      display: inline-block;
      font-size: .85rem;
      line-height: 1;
      padding: .35rem .5rem;
      border-radius: .5rem;
      background: rgba(99, 102, 241, .12);
      color: #a5b4fc;
      border: 1px solid rgba(99, 102, 241, .35);
    }
    .badge.mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .badge.muted {
      background: rgba(148, 163, 184, .18);
      color: #475569;
      border-color: rgba(148, 163, 184, .35);
    }
    .card {
      background: var(--card-bg, #0b1220);
      color: var(--card-fg, #e5e7eb);
      border-radius: .75rem;
      padding: 1rem;
      box-shadow: 0 16px 32px rgba(15, 23, 42, .18);
    }
    .mb { margin-bottom: .75rem; }
    .mt { margin-top: .75rem; }
    .input { width: 100%; }
    .row { display: flex; gap: .5rem; align-items: center; }
    .row.gap { gap: .75rem; }
    .row.small { gap: .35rem; }
    .grid.two { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
    .grid.two > label { display: flex; flex-direction: column; gap: .35rem; min-width: 0; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border-bottom: 1px solid rgba(148, 163, 184, .2); padding: .5rem .6rem; }
    .button.small { padding: .25rem .5rem; font-size: .9rem; }
    .button.danger { background: #7f1d1d; color: #fff; }

    /* Shared modal chrome */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .2);
      backdrop-filter: blur(1px);
    }
    .modal {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      z-index: 50;
      padding: 1rem;
    }
    .modal-card {
      background: var(--card-bg, #0b1220);
      color: var(--card-fg, #e5e7eb);
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      width: min(760px, 92vw);
      max-height: 72vh;
      overflow: auto;
      box-shadow: 0 14px 34px rgba(15, 23, 42, .35);
      border: 1px solid var(--border-strong, #2b2f3a);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .5rem;
    }
    .modal-scroll-controls {
      position: sticky;
      bottom: 8px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding: 8px 0;
      pointer-events: none;
    }
    .modal-scroll-controls .btn {
      pointer-events: auto;
      border: 1px solid var(--border-strong, #2b2f3a);
      background: rgba(20, 24, 31, .75);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-primary, #e6e9f2);
    }

    .diff {
      color: var(--text-primary, #e6e9f2);
      white-space: pre-wrap;
      background: rgba(15, 23, 42, .45);
      border-radius: .5rem;
      padding: .5rem;
      min-height: 2.25rem;
      word-break: break-word;
    }
    .diff ins.added {
      color: #ef4444;
      background: transparent;
      text-decoration: none;
    }
    .diff del.removed {
      color: #94a3b8;
      text-decoration: line-through;
    }
    .diff .same {
      color: inherit;
    }
  </style>
  {% block extra_head %}{% endblock %}
  <script src="{{ static_base }}vendor/htmx.min.js?v=1.9.12"></script>
  <script>
    (function () {
      if (!window.htmx || !window.htmx.version) {
        console.error('[HTMX] Not loaded — param controls will NOT render.');
      }
    })();
  </script>
  <script type="module" src="{{ static_base }}js/examples.js"></script>
</head>
<body data-root="{{ root }}">

  <header class="top-nav">
    <div class="nav-container">
      <div class="nav-brand">
        <a class="brand-text" href="{{ home_url }}">Silhouette</a>
      </div>
      <nav class="nav-main">
        <a href="{{ home_url }}" class="nav-link {% if current_path.startswith(home_path) %}active{% endif %}">Home</a>
        <a href="{{ skills_url }}" class="nav-link {% if current_path.startswith(skills_path) %}active{% endif %}">Skills</a>
        <a href="{{ interop_url }}" class="nav-link {% if current_path.startswith(interop_path) %}active{% endif %}">Interoperability</a>
        <a href="{{ reports_url }}" class="nav-link {% if current_path.startswith(reports_path) %}active{% endif %}">Reports</a>
        <a class="nav-link {% if current_path.startswith(settings_path) %}active{% endif %}" href="{{ settings_url }}">Settings</a>
      </nav>
      <div class="nav-actions">
        <button class="hamburger-btn" id="hamburger-toggle"
                onclick="window.SilhouetteMenuToggle && window.SilhouetteMenuToggle()"
                aria-label="Open settings" aria-expanded="false">
          <span class="hamburger-icon" aria-hidden="true"></span>
        </button>
      </div>
    </div>
  </header>

  <div class="overlay" id="overlay"></div>
  <div class="hamburger-menu" id="hamburger-menu" aria-hidden="true">
    <div class="hamburger-content">
      <div class="hamburger-header">
        <h3>Settings</h3>
        <button class="close-hamburger" id="close-hamburger" aria-label="Close settings">×</button>
      </div>
      <div class="menu-section">
        <h4>Theme</h4>
        <div class="theme-selector">
          <label class="theme-option">
            <input type="radio" name="theme" value="light" checked />
            <span class="theme-label">Light</span>
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="dark" />
            <span class="theme-label">Dark</span>
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="high-contrast" />
            <span class="theme-label">High Contrast</span>
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="professional" />
            <span class="theme-label">Professional</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <main>
    {% block content %}{% endblock %}
  </main>

  <script>
  // --- Minimal KPI refresher (no-HTMX fallback) ---
  (function(){
    function refreshKPI(sel, url){
      var el = document.querySelector(sel);
      if (!el) return;
      try {
        fetch(url, { cache: "no-cache" })
          .then(function(r){ return r.text(); })
          .then(function(html){ el.innerHTML = html; })
          .catch(function(){ /* silent */ });
      } catch(e) { /* silent */ }
    }
    // Expose globally so partials can call it after actions
    window.refreshKPI = refreshKPI;

    var ROOT = {{ root | tojson }};
    try { window.ROOT = ROOT; } catch (e) { /* ignore */ }
    function withRoot(path){
      if (!path) return ROOT;
      return ROOT + path;
    }

    document.addEventListener('DOMContentLoaded', function(){
      // Security KPI
      if (document.querySelector('#kpi-wrap')) {
        refreshKPI('#kpi-wrap', withRoot('/security/summary'));
        setInterval(function(){ refreshKPI('#kpi-wrap', withRoot('/security/summary')); }, 10000);
      }
    });
  })();
  </script>
  <script src="{{ static_base }}js/site.js"></script>
  <script src="{{ static_base }}js/nav.js" defer></script>
  <script src="{{ static_base }}js/panel_manager.js" defer></script>
  <script src="{{ static_base }}js/panel_state_cache.js" defer></script>
  <script src="{{ static_base }}js/pipeline_bus.js" defer></script>
  <script src="{{ static_base }}js/pipeline_tray.js" defer></script>
  {% block extra_scripts %}{% endblock %}
</body>
</html>

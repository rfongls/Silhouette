<!DOCTYPE html>
<html lang="en" data-theme="light">
{# Fallback for static URLs if a handler ever forgets 'request' #}
{% set static_base = request.url_for('static', path='') if request is defined else '/static/' %}
{% set req = request if request is defined else none %}
{% set root = req.scope.get('root_path', '') if req else '' %}
{% set current_path = req.url.path if req and req.url else '' %}
{% set home_url = link_for(req, 'ui_home', '/ui/home') %}
{% set skills_url = link_for(req, 'ui_skills_index', '/ui/skills') %}
{% set interop_url = link_for(req, 'interop_skills', '/ui/interop/skills') %}
{% set reports_url = link_for(req, 'ui_reports', '/reports') %}
{% set settings_url = link_for(req, 'ui_settings_index', '/ui/settings') %}
{% set home_path = root ~ '/ui/home' %}
{% set skills_path = root ~ '/ui/skills' %}
{% set interop_path = root ~ '/ui/interop' %}
{% set reports_path = root ~ '/reports' %}
{% set settings_path = root ~ '/ui/settings' %}
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Silhouette UI</title>
  <meta name="root-path" content="{{ root }}" />
  <meta name="app-root" content="{{ root }}" />
  <link rel="stylesheet" href="{{ static_base }}css/app.css" />
  <link rel="stylesheet" href="{{ static_base }}css/dashboard.css" />
  <style>
    .badge {
      display: inline-block;
      font-size: .85rem;
      line-height: 1;
      padding: .35rem .5rem;
      border-radius: .5rem;
      background: rgba(99, 102, 241, .12);
      color: #a5b4fc;
      border: 1px solid rgba(99, 102, 241, .35);
    }
    .badge.mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .badge.muted {
      background: rgba(148, 163, 184, .18);
      color: #475569;
      border-color: rgba(148, 163, 184, .35);
    }
    .card {
      background: var(--card-bg, #0b1220);
      color: var(--card-fg, #e5e7eb);
      border-radius: .75rem;
      padding: 1rem;
      box-shadow: 0 16px 32px rgba(15, 23, 42, .18);
    }
    .mb { margin-bottom: .75rem; }
    .mt { margin-top: .75rem; }
    .input { width: 100%; }
    .row { display: flex; gap: .5rem; align-items: center; }
    .row.gap { gap: .75rem; }
    .row.small { gap: .35rem; }
    .grid.two { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border-bottom: 1px solid rgba(148, 163, 184, .2); padding: .5rem .6rem; }
    .button.small { padding: .25rem .5rem; font-size: .9rem; }
    .button.danger { background: #7f1d1d; color: #fff; }
  </style>
  {% block extra_head %}{% endblock %}
  <script src="{{ static_base }}htmx.min.js"></script>
  <script type="module" src="{{ static_base }}js/examples.js"></script>
</head>
<body data-root="{{ root }}">

  <header class="top-nav">
    <div class="nav-container">
      <div class="nav-brand">
        <a class="brand-text" href="{{ home_url }}">Silhouette</a>
      </div>
      <nav class="nav-main">
        <a href="{{ home_url }}" class="nav-link {% if current_path.startswith(home_path) %}active{% endif %}">Home</a>
        <a href="{{ skills_url }}" class="nav-link {% if current_path.startswith(skills_path) %}active{% endif %}">Skills</a>
        <a href="{{ interop_url }}" class="nav-link {% if current_path.startswith(interop_path) %}active{% endif %}">Interoperability</a>
        <a href="{{ reports_url }}" class="nav-link {% if current_path.startswith(reports_path) %}active{% endif %}">Reports</a>
        <a class="nav-link {% if current_path.startswith(settings_path) %}active{% endif %}" href="{{ settings_url }}">Settings</a>
      </nav>
      <div class="nav-actions">
        <button class="hamburger-btn" id="hamburger-toggle"
                onclick="window.SilhouetteMenuToggle && window.SilhouetteMenuToggle()"
                aria-label="Open settings" aria-expanded="false">
          <span class="hamburger-icon" aria-hidden="true"></span>
        </button>
      </div>
    </div>
  </header>

  <div class="overlay" id="overlay"></div>
  <div class="hamburger-menu" id="hamburger-menu" aria-hidden="true">
    <div class="hamburger-content">
      <div class="hamburger-header">
        <h3>Settings</h3>
        <button class="close-hamburger" id="close-hamburger" aria-label="Close settings">×</button>
      </div>
      <div class="menu-section">
        <h4>Theme</h4>
        <div class="theme-selector">
          <label class="theme-option">
            <input type="radio" name="theme" value="light" checked />
            <span class="theme-label">Light</span>
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="dark" />
            <span class="theme-label">Dark</span>
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="high-contrast" />
            <span class="theme-label">High Contrast</span>
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="professional" />
            <span class="theme-label">Professional</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <main>
    {% block content %}{% endblock %}
  </main>

  <script>
  // --- Minimal KPI refresher (no-HTMX fallback) ---
  (function(){
    function refreshKPI(sel, url){
      var el = document.querySelector(sel);
      if (!el) return;
      try {
        fetch(url, { cache: "no-cache" })
          .then(function(r){ return r.text(); })
          .then(function(html){ el.innerHTML = html; })
          .catch(function(){ /* silent */ });
      } catch(e) { /* silent */ }
    }
    // Expose globally so partials can call it after actions
    window.refreshKPI = refreshKPI;

    var ROOT = {{ root | tojson }};
    try { window.ROOT = ROOT; } catch (e) { /* ignore */ }
    function withRoot(path){
      if (!path) return ROOT;
      return ROOT + path;
    }

    document.addEventListener('DOMContentLoaded', function(){
      // Security KPI
      if (document.querySelector('#kpi-wrap')) {
        refreshKPI('#kpi-wrap', withRoot('/security/summary'));
        setInterval(function(){ refreshKPI('#kpi-wrap', withRoot('/security/summary')); }, 10000);
      }
    });
  })();
  </script>
  <script>
  /* ===== Global helpers ===== */
  window.esc = s => (s ?? "").toString()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");

  window.diffChars = (a, b) => ({ beforeHTML: window.esc(a ?? ""), afterHTML: window.esc(b ?? "") });
  window.diffLines = (a, b) => ({ beforeHTML: window.esc(a ?? ""), afterHTML: window.esc(b ?? "") });

  window.initDeidModal = function initDeidModal(sel) {
    const root = (typeof sel === "string") ? document.querySelector(sel) : sel;
    if (!root) return;

    if (root.__deidInit) {
      root.__deidInit.updateHiddenParam();
      root.__deidInit.updatePath();
      root.__deidInit.syncParamUI();
      return;
    }

    const $ = id => root.querySelector(id);

    const seg = $('#m-seg');
    const fld = $('#m-field');
    const cmp = $('#m-comp');
    const sub = $('#m-sub');
    const actionSel = $('#m-action');
    const modeWrap = $('#m-param-mode-wrap');
    const modeSel = $('#m-param-mode');
    const presetW = $('#m-preset-wrap');
    const presetSel = $('#m-preset');
    const freeW = $('#m-free-wrap');
    const freeInp = $('#m-free');
    const regexW = $('#m-regex-wrap');
    const rxPat = $('#m-rx-pattern');
    const rxReplW = $('#m-rx-repl-wrap');
    const rxRepl = $('#m-rx-repl');
    const pathBadge = $('#m-path-badge');
    const hiddenParam = $('#m-param-hidden');
    const beforeField = $('#m-before-diff');
    const afterField = $('#m-after-diff');
    const msgBefore = $('#m-msg-before');
    const msgAfter = $('#m-msg-after');
    const sampleArea = $('#m-sample');
    const testBtn = root.querySelector('[data-deid-test]');
    const form = root.querySelector('form');

    function formatPath() {
      const s = (seg?.value || "").trim().toUpperCase();
      const f = (fld?.value || "").trim();
      const c = (cmp?.value || "").trim();
      const u = (sub?.value || "").trim();
      if (!s || !f) return '—';
      return s + ':' + f + (c ? '.' + c : '') + (u ? '.' + u : '');
    }

    function updatePath() {
      if (pathBadge) pathBadge.textContent = formatPath();
    }

    function updateHiddenParam() {
      if (!hiddenParam) return;
      const action = actionSel?.value || '';
      hiddenParam.name = '';
      hiddenParam.value = '';
      [presetSel, freeInp, rxPat, rxRepl].forEach(el => { if (el) el.name = ''; });

      if (action === 'preset') {
        if (modeSel?.value === 'preset') {
          if (presetSel) presetSel.name = 'param';
        } else if (freeInp) {
          freeInp.name = 'param';
        }
        return;
      }

      if (action === 'replace' || action === 'mask' || action === 'hash') {
        if (freeInp) freeInp.name = 'param';
        return;
      }

      if (action === 'regex_redact') {
        if (rxPat) rxPat.name = 'param';
        return;
      }

      if (action === 'regex_replace') {
        hiddenParam.name = 'param';
        hiddenParam.value = JSON.stringify({ pattern: rxPat?.value || '', repl: rxRepl?.value || '' });
      }
    }

    function syncParamUI() {
      const act = actionSel?.value || '';
      if (modeWrap) modeWrap.style.display = 'none';
      if (presetW) presetW.style.display = 'none';
      if (freeW) freeW.style.display = 'none';
      if (regexW) regexW.style.display = 'none';
      if (rxReplW) rxReplW.style.display = 'none';

      if (act === 'preset') {
        if (modeWrap) modeWrap.style.display = '';
        if (modeSel?.value === 'preset') {
          if (presetW) presetW.style.display = '';
        } else if (freeW) {
          freeW.style.display = '';
        }
      } else if (act === 'replace' || act === 'mask' || act === 'hash') {
        if (freeW) freeW.style.display = '';
      } else if (act === 'regex_redact') {
        if (regexW) regexW.style.display = '';
      } else if (act === 'regex_replace') {
        if (regexW) regexW.style.display = '';
        if (rxReplW) rxReplW.style.display = '';
      }

      updateHiddenParam();
    }

    async function testDeidRule() {
      try {
        if (beforeField) beforeField.innerHTML = window.esc('…');
        if (afterField) afterField.innerHTML = window.esc('…');
        if (msgBefore) msgBefore.innerHTML = window.esc('…');
        if (msgAfter) msgAfter.innerHTML = window.esc('…');

        const fd = new FormData();
        fd.append('message_text', sampleArea?.value || '');
        fd.append('segment', seg?.value || '');
        fd.append('field', fld?.value || '');
        fd.append('component', cmp?.value || '');
        fd.append('subcomponent', sub?.value || '');
        const act = actionSel?.value || '';
        fd.append('action', act);

        updateHiddenParam();
        let param = '';
        if (act === 'preset') {
          param = (modeSel?.value === 'preset') ? (presetSel?.value || '') : (freeInp?.value || '');
        } else if (act === 'replace' || act === 'mask' || act === 'hash') {
          param = freeInp?.value || '';
        } else if (act === 'regex_redact') {
          param = rxPat?.value || '';
        } else if (act === 'regex_replace') {
          param = JSON.stringify({ pattern: rxPat?.value || '', repl: rxRepl?.value || '' });
        }
        fd.append('param', param);

        const url = root.getAttribute('data-test-endpoint');
        const resp = await fetch(url, { method: 'POST', body: fd });
        let data;
        try {
          data = await resp.json();
        } catch (err) {
          data = { ok: false, error: 'Non-JSON response' };
        }

        if (!data.ok) {
          if (beforeField) beforeField.innerHTML = '—';
          if (afterField) afterField.innerHTML = window.esc('Error: ' + (data.error || 'unknown'));
          const sample = sampleArea?.value || '';
          if (msgBefore) msgBefore.innerHTML = window.esc(sample);
          if (msgAfter) msgAfter.innerHTML = window.esc(sample);
          return;
        }

        const beforeVal = data.preview.before ?? '';
        const afterVal = data.preview.after ?? '';
        const dField = window.diffChars(beforeVal, afterVal);
        if (beforeField) beforeField.innerHTML = dField.beforeHTML;
        if (afterField) afterField.innerHTML = dField.afterHTML;

        const sample = sampleArea?.value || '';
        const lineB = data.preview.line_before ?? sample;
        const lineA = data.preview.line_after ?? data.preview.message_after ?? sample;
        const dMsg = window.diffLines(lineB, lineA);
        if (msgBefore) msgBefore.innerHTML = dMsg.beforeHTML;
        if (msgAfter) msgAfter.innerHTML = dMsg.afterHTML;
      } catch (error) {
        if (afterField) afterField.innerHTML = window.esc('JS error: ' + error);
      }
    }

    [seg, fld, cmp, sub].forEach(el => el && el.addEventListener('input', updatePath));
    if (actionSel) actionSel.addEventListener('change', syncParamUI);
    if (modeSel) modeSel.addEventListener('change', syncParamUI);
    if (form) form.addEventListener('submit', updateHiddenParam);
    if (testBtn) testBtn.addEventListener('click', testDeidRule);

    updatePath();
    syncParamUI();

    root.__deidInit = { updateHiddenParam, updatePath, syncParamUI };
  };
  </script>
  <script src="{{ static_base }}js/nav.js" defer></script>
  <script src="{{ static_base }}js/panel_manager.js" defer></script>
  <script src="{{ static_base }}js/panel_state_cache.js" defer></script>
  <script src="{{ static_base }}js/pipeline_bus.js" defer></script>
  <script src="{{ static_base }}js/pipeline_tray.js" defer></script>
  {% block extra_scripts %}{% endblock %}
</body>
</html>

import json
import os
import subprocess
import sys
from pathlib import Path


def run(args, env=None, check=False):
    return subprocess.run(
        [sys.executable, "-m", "silhouette_core.cli"] + args,
        capture_output=True,
        text=True,
        check=check,
        env=env,
    )


def test_recon_denied_without_scope_ack(tmp_path):
    env = os.environ.copy()
    env["PYTHONUNBUFFERED"] = "1"
    r = run(
        [
            "security",
            "--ack-authorized",
            "pentest",
            "recon",
            "--target",
            "not-in-scope.example",
            "--scope-file",
            "docs/cyber/scope_example.txt",
        ],
        env=env,
    )
    combined = r.stdout + r.stderr
    assert r.returncode != 0
    assert "Denied" in combined or "not in scope" in combined


def test_recon_ok_with_scope_and_ack(tmp_path):
    env = os.environ.copy()
    env["PYTHONUNBUFFERED"] = "1"
    r = run(
        [
            "security",
            "--ack-authorized",
            "pentest",
            "recon",
            "--target",
            "sub.example.com",
            "--scope-file",
            "docs/cyber/scope_example.txt",
        ],
        env=env,
        check=False,
    )
    assert r.returncode == 0
    latest = max(Path("out/security").glob("2*"))
    recon_json = latest / "active" / "recon.json"
    assert recon_json.exists()


def test_gate_ok_with_auth_and_scope(tmp_path):
    env = os.environ.copy()
    env["PYTHONUNBUFFERED"] = "1"
    auth = tmp_path / "auth.pdf"
    auth.write_text("auth")
    r = run(
        [
            "security",
            "--ack-authorized",
            "pentest",
            "gate",
            "--target",
            "sub.example.com",
            "--scope-file",
            "docs/cyber/scope_example.txt",
            "--auth-doc",
            str(auth),
        ],
        env=env,
        check=False,
    )
    assert r.returncode == 0
    path = Path(r.stdout.strip())
    assert path.name == "pentest_gate.json"
    assert path.exists()


def test_gate_denied_without_auth_doc(tmp_path):
    env = os.environ.copy()
    env["PYTHONUNBUFFERED"] = "1"
    missing = tmp_path / "missing.pdf"
    r = run(
        [
            "security",
            "--ack-authorized",
            "pentest",
            "gate",
            "--target",
            "sub.example.com",
            "--scope-file",
            "docs/cyber/scope_example.txt",
            "--auth-doc",
            str(missing),
        ],
        env=env,
    )
    combined = r.stdout + r.stderr
    assert r.returncode != 0
    assert "Authorization document" in combined


def test_gate_denied_out_of_scope(tmp_path):
    env = os.environ.copy()
    env["PYTHONUNBUFFERED"] = "1"
    auth = tmp_path / "auth.pdf"
    auth.write_text("auth")
    r = run(
        [
            "security",
            "--ack-authorized",
            "pentest",
            "gate",
            "--target",
            "out.example.org",
            "--scope-file",
            "docs/cyber/scope_example.txt",
            "--auth-doc",
            str(auth),
        ],
        env=env,
    )
    combined = r.stdout + r.stderr
    assert r.returncode != 0
    assert "Denied" in combined or "not in scope" in combined


def test_playbook_creates_output(tmp_path):
    env = os.environ.copy()
    env["PYTHONUNBUFFERED"] = "1"
    r = run(
        [
            "security",
            "--ack-authorized",
            "pentest",
            "playbook",
            "--incident",
            "ransomware",
        ],
        env=env,
        check=False,
    )
    assert r.returncode == 0
    path = Path(r.stdout.strip())
    assert path.name == "ir_playbook.json"
    assert path.exists()
    data = json.loads(path.read_text())
    assert data["incident"] == "ransomware"
    assert "isolate_systems" in data["steps"]


def test_playbook_credential(tmp_path):
    env = os.environ.copy()
    env["PYTHONUNBUFFERED"] = "1"
    r = run(
        [
            "security",
            "--ack-authorized",
            "pentest",
            "playbook",
            "--incident",
            "credential",
        ],
        env=env,
        check=False,
    )
    assert r.returncode == 0
    path = Path(r.stdout.strip())
    data = json.loads(path.read_text())
    assert data["incident"] == "credential"
    assert "reset_credentials" in data["steps"]


def test_netforensics_creates_output(tmp_path):
    env = os.environ.copy()
    env["PYTHONUNBUFFERED"] = "1"
    pcap = tmp_path / "sample.pcap"
    pcap.write_text("pcap")
    r = run(
        [
            "security",
            "--ack-authorized",
            "pentest",
            "netforensics",
            "--pcap",
            str(pcap),
        ],
        env=env,
        check=False,
    )
    assert r.returncode == 0
    path = Path(r.stdout.strip())
    assert path.name == "netforensics.json"
    assert path.exists()


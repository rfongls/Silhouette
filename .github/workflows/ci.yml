name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dev deps
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt

    - name: Lint
      run: |
        ruff check .

    - name: Run unit tests with coverage
      run: |
        coverage run -m pytest --maxfail=1 --disable-warnings -q
        coverage xml
        coverage report --fail-under=80

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        fail_ci_if_error: true

    - name: Smoke-test CLI
      run: |
        python -m cli.main --no-repl
        printf ":replay\n:exit\n" | python -m cli.main | grep -q "Replayed"
        printf ":selfcheck\n:exit\n" | python -m cli.main | grep -q "Missing required files"
        printf ":backup\n:exit\n" | python -m cli.main | grep -q "Backup complete"

    - name: Self-deploy smoke
      run: |
        python -m silhouette_core.profile_exporter --output profile.json
        python -m silhouette_core.distiller --output distillate.json
        python -m silhouette_core.package_clone --profile profile.json --distillate distillate.json --version 1
        printf ":agent deploy tmp_deploy\n:exit\n" | python -m cli.main | grep -q "Deployed clone"

    - name: Doc-link check
      run: |
        pip install markdown-link-check
        markdown-link-check "docs/**/*.md"

